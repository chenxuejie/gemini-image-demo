<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 2.5 Flash Lite å›¾ç‰‡/è§†é¢‘æ¨ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .model-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ebff 100%);
            border-radius: 12px;
            border: 1px solid #e0e5ff;
        }
        
        .model-selector label {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }
        
        .model-selector select {
            padding: 10px 20px;
            font-size: 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            min-width: 220px;
            transition: all 0.3s ease;
        }
        
        .model-selector select:hover {
            border-color: #764ba2;
        }
        
        .model-selector select:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2);
        }
        
        /* æ¨¡å¼åˆ‡æ¢æ ‡ç­¾ */
        .mode-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #667eea;
        }
        
        .mode-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
            color: #667eea;
        }
        
        .mode-tab:hover {
            background: #f0f2ff;
        }
        
        .mode-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .mode-tab .icon {
            margin-right: 8px;
        }
        
        /* æ¨¡å¼å†…å®¹åŒºåŸŸ */
        .mode-content {
            display: none;
        }
        
        .mode-content.active {
            display: block;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #666;
            font-size: 16px;
        }
        
        .file-input {
            display: none;
        }
        
        .preview-container {
            display: none;
            margin-bottom: 20px;
        }
        
        .preview-container.show {
            display: block;
        }
        
        .preview-title {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .image-preview, .video-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            display: block;
            margin: 0 auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        
        .file-info {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .settings-section {
            display: none;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 1px solid #e0e5ff;
        }
        
        .settings-section.show {
            display: block;
        }
        
        .settings-section h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }
        
        .settings-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .settings-row:last-child {
            margin-bottom: 0;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group label {
            color: #666;
            font-size: 14px;
            min-width: 80px;
        }
        
        .input-group input, .input-group select {
            width: 120px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-group span {
            color: #888;
            font-size: 13px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            color: #666;
            font-size: 14px;
            cursor: pointer;
        }
        
        .settings-info {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        
        .radio-label {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .radio-label:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .radio-label input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .radio-label input[type="radio"]:checked + .radio-text {
            color: #667eea;
            font-weight: 600;
        }
        
        .radio-label:has(input[type="radio"]:checked) {
            border-color: #667eea;
            background: #f0f2ff;
        }
        
        .radio-text {
            font-size: 15px;
            color: #333;
        }
        
        .radio-desc {
            font-size: 12px;
            color: #888;
            width: 100%;
            margin-left: 30px;
        }
        
        .frames-settings {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0e5ff;
        }
        
        .preview-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .preview-btn:hover {
            background: #218838;
        }
        
        .preview-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .resized-preview-container {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            border: 1px solid #c8e6c9;
        }
        
        .resized-preview-container.show {
            display: block;
        }
        
        .resized-preview-container h5 {
            margin-bottom: 10px;
            color: #2e7d32;
            font-size: 14px;
        }
        
        .resized-preview-container img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }
        
        .resized-info {
            text-align: center;
            margin-top: 10px;
            color: #2e7d32;
            font-size: 13px;
        }
        
        .prompt-section {
            margin-bottom: 20px;
        }
        
        .prompt-section label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        .prompt-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s;
        }
        
        .prompt-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result-section {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: #f8f9ff;
            border-radius: 15px;
            border: 1px solid #e0e5ff;
        }
        
        .result-section.show {
            display: block;
        }
        
        .result-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .token-info {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .token-box {
            flex: 1;
            min-width: 150px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .token-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .token-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }
        
        /* è¯¦ç»† Token ä¿¡æ¯æ ·å¼ */
        .token-details-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .token-details-section h5 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }
        
        .token-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .token-detail-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e5ff;
        }
        
        .token-detail-card h6 {
            font-size: 13px;
            color: #667eea;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .token-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #e8ebff;
        }
        
        .token-detail-item:last-child {
            border-bottom: none;
        }
        
        .token-detail-label {
            font-size: 12px;
            color: #666;
        }
        
        .token-detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .token-detail-value.highlight {
            color: #667eea;
        }
        
        .token-detail-value.thinking {
            color: #ff9800;
        }
        
        .token-detail-value.tool {
            color: #4caf50;
        }
        
        .info-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .info-box h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .info-box p {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        
        .frames-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .frames-preview img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .processed-media-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .processed-media-section h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .processed-media-section img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }
        
        .response-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .error-message {
            background: #fff0f0;
            border: 1px solid #ffcccc;
            color: #cc0000;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* äººè„¸è¯†åˆ«æ¨¡å¼æ ·å¼ */
        .face-management-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e5ff;
        }
        
        .face-management-section h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .register-face-area {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .register-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .register-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
        }
        
        .register-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .registered-faces-area {
            background: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        .registered-faces-area h5 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .refresh-btn {
            padding: 5px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .refresh-btn:hover {
            background: #764ba2;
        }
        
        .faces-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .face-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f0f2ff;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e0e5ff;
        }
        
        .face-item .face-name {
            font-weight: 600;
            color: #333;
        }
        
        .face-item .face-count {
            font-size: 12px;
            color: #666;
        }
        
        .face-item .delete-face-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .face-item .delete-face-btn:hover {
            background: #c82333;
        }
        
        .no-faces-text {
            color: #888;
            font-size: 14px;
        }
        
        .face-recognition-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e5ff;
        }
        
        .face-recognition-section h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .face-recognition-settings {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        
        .face-result-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e0e5ff;
        }
        
        .face-result-section h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .face-summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .face-summary-box p {
            margin: 0;
        }
        
        .face-details-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .face-details-box h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .face-details-list {
            font-size: 14px;
        }
        
        .face-detail-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .face-detail-item:last-child {
            border-bottom: none;
        }
        
        .face-detail-item .time {
            color: #666;
            font-size: 12px;
        }
        
        .face-detail-item .name {
            font-weight: 600;
        }
        
        .face-detail-item .name.recognized {
            color: #28a745;
        }
        
        .face-detail-item .name.unknown {
            color: #dc3545;
        }
        
        .face-detail-item .similarity {
            font-size: 12px;
            color: #888;
        }
        
        .gemini-analysis-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .gemini-analysis-box h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .gemini-analysis-content {
            white-space: pre-wrap;
            font-size: 14px;
            color: #555;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .processing-time-box {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 13px;
            color: #2e7d32;
        }
        
        /* ç›¸ä¼¼åº¦ç»Ÿè®¡æ ·å¼ */
        .similarity-stats-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .similarity-stats-box h5 {
            margin-bottom: 12px;
            color: #333;
        }
        
        .similarity-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .similarity-stat-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ebff 100%);
            border: 1px solid #e0e5ff;
            border-radius: 10px;
            padding: 15px;
        }
        
        .similarity-stat-card .person-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .similarity-stat-card .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 13px;
        }
        
        .similarity-stat-card .stat-label {
            color: #666;
        }
        
        .similarity-stat-card .stat-value {
            font-weight: 600;
            color: #667eea;
        }
        
        .similarity-stat-card .stat-value.high {
            color: #28a745;
        }
        
        .similarity-stat-card .stat-value.medium {
            color: #ffc107;
        }
        
        .similarity-stat-card .stat-value.low {
            color: #dc3545;
        }
        
        .similarity-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .similarity-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* æ ‡æ³¨å¸§å›¾ç‰‡å±•ç¤ºæ ·å¼ */
        .annotated-frames-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .annotated-frames-box h5 {
            margin-bottom: 12px;
            color: #333;
        }
        
        .annotated-frames-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .annotated-frame-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #e0e5ff;
        }
        
        .annotated-frame-item:hover {
            transform: scale(1.03);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-color: #667eea;
        }
        
        .annotated-frame-item img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            display: block;
        }
        
        .annotated-frame-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 20px 8px 8px;
            font-size: 12px;
        }
        
        .annotated-frame-info .frame-time {
            font-weight: 600;
        }
        
        .annotated-frame-info .frame-stats {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }
        
        .annotated-frame-info .stat-recognized {
            color: #4ade80;
        }
        
        .annotated-frame-info .stat-stranger {
            color: #f87171;
        }
        
        /* å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†æ ·å¼ */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }
        
        .image-modal.show {
            display: flex;
        }
        
        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        
        .image-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
            transition: color 0.2s;
        }
        
        .image-modal-close:hover {
            color: #ff6b6b;
        }
        
        .image-modal-img {
            max-width: 100%;
            max-height: calc(90vh - 60px);
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }
        
        .image-modal-info {
            text-align: center;
            color: white;
            margin-top: 15px;
            font-size: 16px;
        }
        
        .image-modal-info .info-recognized {
            color: #4ade80;
            font-weight: 600;
        }
        
        .image-modal-info .info-stranger {
            color: #f87171;
            font-weight: 600;
        }
        
        /* è§†é¢‘æ ‡æ³¨æ¨¡å¼æ ·å¼ */
        .label-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e5ff;
        }
        
        .label-section h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .add-person-area {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            background: white;
            padding: 15px;
            border-radius: 10px;
        }
        
        .person-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .add-person-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-person-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }
        
        .add-person-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .persons-list-area {
            margin-top: 15px;
        }
        
        .persons-list-area h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .persons-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .person-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #667eea;
        }
        
        .person-item .person-name {
            font-weight: 600;
            color: #333;
        }
        
        .person-item .remove-person-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .person-item .remove-person-btn:hover {
            background: #c82333;
        }
        
        .no-persons-text {
            color: #888;
            font-size: 14px;
        }
        
        .label-settings {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
            background: white;
            padding: 15px;
            border-radius: 10px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        .label-stats {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .label-stats p {
            margin: 5px 0;
            color: #333;
        }
        
        .download-area {
            text-align: center;
            margin: 20px 0;
        }
        
        .download-btn {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }
        
        .processing-time {
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        /* å®æ—¶æ ‡æ³¨æ¨¡å¼æ ·å¼ */
        .realtime-section {
            background: #f0fff4;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #c6f6d5;
        }
        
        .realtime-section h4 {
            margin-bottom: 15px;
            color: #276749;
            font-size: 18px;
        }
        
        .realtime-settings {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
            background: white;
            padding: 15px;
            border-radius: 10px;
        }
        
        .realtime-preview-section {
            background: #1a1a2e;
            border: 1px solid #16213e;
        }
        
        .realtime-preview-section h4 {
            color: #eee;
        }
        
        .realtime-display {
            background: #000;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .realtime-info {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            color: #aaa;
            font-size: 14px;
        }
        
        .realtime-faces-list {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .realtime-face-tag {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .realtime-face-tag.recognized {
            background: #48bb78;
            color: white;
        }
        
        .realtime-face-tag.unknown {
            background: #ecc94b;
            color: #744210;
        }
        
        .realtime-complete-section {
            background: #f0fff4;
            border: 2px solid #48bb78;
        }
        
        .realtime-stats {
            background: white;
            padding: 15px;
            border-radius: 10px;
        }
        
        .realtime-stats p {
            margin: 8px 0;
            color: #333;
        }
        
        .realtime-progress {
            margin-bottom: 15px;
        }
        
        /* å¼¹å‡ºæ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ Gemini å›¾ç‰‡/è§†é¢‘æ¨ç†</h1>
        <p class="subtitle">ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘ï¼Œä½¿ç”¨ Gemini AI è¿›è¡Œåˆ†æ</p>
        
        <!-- æ¨¡å‹é€‰æ‹© -->
        <div class="model-selector">
            <label for="modelSelect">ğŸ¤– é€‰æ‹©æ¨¡å‹:</label>
            <select id="modelSelect">
                <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                <option value="gemini-2.0-flash-lite-001">Gemini 2.0 Flash Lite</option>
                <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
            </select>
        </div>
        
        <!-- åª’ä½“åˆ†è¾¨ç‡è®¾ç½®ï¼ˆå›¾ç‰‡å’Œè§†é¢‘æ¨¡å¼éƒ½æ˜¾ç¤ºï¼‰ -->
        <div class="settings-section show" id="mediaResolutionSettings">
            <h4>ğŸ“Š åª’ä½“åˆ†è¾¨ç‡è®¾ç½®</h4>
            
            <!-- Media Resolution -->
            <div class="settings-row">
                <div class="input-group">
                    <label for="mediaResolutionSelect">åˆ†è¾¨ç‡:</label>
                    <select id="mediaResolutionSelect" style="width: 200px;">
                        <option value="unspecified">é»˜è®¤ (è‡ªåŠ¨)</option>
                        <option value="low">Low (ä½åˆ†è¾¨ç‡ï¼Œçœ tokens)</option>
                        <option value="medium">Medium (ä¸­ç­‰åˆ†è¾¨ç‡)</option>
                        <option value="high">High (é«˜åˆ†è¾¨ç‡)</option>
                    </select>
                </div>
            </div>
            
            <p class="settings-info" id="mediaResolutionInfo">
                ğŸ’¡ <strong>åˆ†è¾¨ç‡è®¾ç½®</strong>: å½±å“å›¾ç‰‡/è§†é¢‘çš„å¤„ç†ç²¾åº¦å’Œ token æ¶ˆè€—ã€‚<br>
                ğŸ“Š è§†é¢‘: Low ~100 tokens/ç§’ï¼Œé»˜è®¤ ~300 tokens/ç§’ã€‚<br>
                ğŸ–¼ï¸ å›¾ç‰‡: ä½åˆ†è¾¨ç‡å¯å‡å°‘ token æ¶ˆè€—ï¼Œé«˜åˆ†è¾¨ç‡å¯è·å¾—æ›´å¤šç»†èŠ‚ã€‚
            </p>
        </div>
        
        <!-- è§†é¢‘é«˜çº§è®¾ç½®ï¼ˆä»…è§†é¢‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
        <div class="settings-section" id="videoAdvancedSettings" style="display: none;">
            <h4>ğŸ¬ è§†é¢‘å¤„ç†é«˜çº§è®¾ç½®</h4>
            
            <!-- Video FPS (ä»…è§†é¢‘æ¨¡å¼) -->
            <div class="settings-row">
                <div class="input-group">
                    <label for="videoFpsInput">é‡‡æ ·å¸§ç‡:</label>
                    <input type="number" id="videoFpsInput" value="1" min="0.1" max="24" step="0.1" style="width: 80px;">
                    <span>fps (0.1-24)</span>
                </div>
            </div>
            
            <!-- Video Clip (Start/End Offset) -->
            <div class="settings-row">
                <div class="input-group">
                    <label for="startOffsetInput">èµ·å§‹æ—¶é—´:</label>
                    <input type="text" id="startOffsetInput" placeholder="0s" style="width: 100px;">
                    <span>ç§’</span>
                </div>
                <div class="input-group">
                    <label for="endOffsetInput">ç»“æŸæ—¶é—´:</label>
                    <input type="text" id="endOffsetInput" placeholder="ç•™ç©º=å…¨éƒ¨" style="width: 100px;">
                    <span>ç§’</span>
                </div>
            </div>
            
            <p class="settings-info">
                ğŸ’¡ <strong>é‡‡æ ·å¸§ç‡</strong>: é»˜è®¤ 1 fpsï¼Œæœ€é«˜ 24 fpsã€‚æ›´é«˜å¸§ç‡æ•æ‰æ›´å¤šç»†èŠ‚ä½†æ¶ˆè€—æ›´å¤š tokensã€‚<br>
                â±ï¸ <strong>æ—¶é—´è£å‰ª</strong>: å¯æŒ‡å®šåˆ†æè§†é¢‘çš„èµ·å§‹å’Œç»“æŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œç•™ç©ºåˆ™åˆ†ææ•´ä¸ªè§†é¢‘ã€‚
            </p>
        </div>
        
        <!-- æ¨¡å¼åˆ‡æ¢æ ‡ç­¾ -->
        <div class="mode-tabs">
            <div class="mode-tab active" data-mode="image">
                <span class="icon">ğŸ–¼ï¸</span>å›¾ç‰‡åˆ†æ
            </div>
            <div class="mode-tab" data-mode="video">
                <span class="icon">ğŸ¬</span>è§†é¢‘åˆ†æ
            </div>
            <div class="mode-tab" data-mode="face">
                <span class="icon">ğŸ‘¤</span>äººè„¸è¯†åˆ«
            </div>
            <div class="mode-tab" data-mode="label">
                <span class="icon">ğŸ“¹</span>è§†é¢‘æ ‡æ³¨
            </div>
            <div class="mode-tab" data-mode="realtime">
                <span class="icon">ğŸ¥</span>å®æ—¶æ ‡æ³¨
            </div>
            <div class="mode-tab" data-mode="cache">
                <span class="icon">ğŸ“¦</span>è§†é¢‘Cache
            </div>
            <div class="mode-tab" data-mode="stranger">
                <span class="icon">ğŸ•µï¸</span>é™Œç”Ÿäººæ£€æµ‹
            </div>
        </div>
        
        <!-- å›¾ç‰‡æ¨¡å¼ -->
        <div class="mode-content active" id="imageMode">
            <div class="upload-area" id="imageUploadArea">
                <div class="upload-icon">ğŸ“</div>
                <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                <p class="upload-text" style="font-size: 12px; color: #999; margin-top: 10px;">æ”¯æŒ JPG, PNG, GIF, WebP æ ¼å¼</p>
            </div>
            <input type="file" class="file-input" id="imageFileInput" accept="image/*">
            
            <div class="preview-container" id="imagePreviewContainer">
                <p class="preview-title">ğŸ“· åŸå§‹å›¾ç‰‡é¢„è§ˆ</p>
                <img class="image-preview" id="imagePreview" src="" alt="é¢„è§ˆå›¾ç‰‡">
                <p class="file-info" id="imageInfo"></p>
            </div>
            
            <div class="settings-section" id="imageSettings">
                <h4>ğŸ“ è°ƒæ•´å›¾ç‰‡å°ºå¯¸</h4>
                <div class="settings-row">
                    <div class="input-group">
                        <label for="widthInput">å®½åº¦:</label>
                        <input type="number" id="widthInput" placeholder="å®½åº¦" min="1" max="4096">
                        <span>px</span>
                    </div>
                    <div class="input-group">
                        <label for="heightInput">é«˜åº¦:</label>
                        <input type="number" id="heightInput" placeholder="é«˜åº¦" min="1" max="4096">
                        <span>px</span>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="keepRatio" checked>
                        <label for="keepRatio">ä¿æŒå®½é«˜æ¯”</label>
                    </div>
                </div>
                <p class="settings-info" id="resizeInfo">ç•™ç©ºåˆ™ä½¿ç”¨åŸå§‹å°ºå¯¸</p>
                <button class="preview-btn" id="previewResizeBtn">ğŸ‘ï¸ é¢„è§ˆè°ƒæ•´åçš„å›¾ç‰‡</button>
                
                <div class="resized-preview-container" id="resizedPreviewContainer">
                    <h5>âœ… è°ƒæ•´åçš„å›¾ç‰‡é¢„è§ˆ</h5>
                    <img id="resizedImagePreview" src="" alt="è°ƒæ•´åçš„å›¾ç‰‡">
                    <p class="resized-info" id="resizedInfo"></p>
                </div>
            </div>
        </div>
        
        <!-- è§†é¢‘æ¨¡å¼ -->
        <div class="mode-content" id="videoMode">
            <div class="upload-area" id="videoUploadArea">
                <div class="upload-icon">ğŸ¬</div>
                <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘åˆ°æ­¤å¤„ä¸Šä¼ </p>
                <p class="upload-text" style="font-size: 12px; color: #999; margin-top: 10px;">æ”¯æŒ MP4, WebM, MOV, TS æ ¼å¼ï¼Œæœ€å¤§ 100MB</p>
            </div>
            <input type="file" class="file-input" id="videoFileInput" accept="video/*,.ts,.TS">
            
            <div class="preview-container" id="videoPreviewContainer">
                <p class="preview-title">ğŸ¬ è§†é¢‘é¢„è§ˆ</p>
                <video class="video-preview" id="videoPreview" controls></video>
                <p class="file-info" id="videoInfo"></p>
            </div>
            
            <div class="settings-section" id="videoSettings">
                <h4>âš™ï¸ è§†é¢‘å¤„ç†è®¾ç½®</h4>
                
                <!-- å¤„ç†æ¨¡å¼é€‰æ‹© -->
                <div class="settings-row">
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="videoMode" value="direct" id="modeDirectRadio" checked>
                            <span class="radio-text">ğŸ¬ ç›´æ¥å‘é€è§†é¢‘</span>
                            <span class="radio-desc">å°†å®Œæ•´è§†é¢‘ç›´æ¥å‘é€ç»™ Geminiï¼ˆæ¨èï¼‰</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="videoMode" value="frames" id="modeFramesRadio">
                            <span class="radio-text">ğŸ–¼ï¸ æå–å¸§æ¨¡å¼</span>
                            <span class="radio-desc">ä»è§†é¢‘ä¸­æå–å¸§å›¾ç‰‡åå‘é€</span>
                        </label>
                    </div>
                </div>
                
                <!-- å¸§æå–è®¾ç½®ï¼ˆä»…åœ¨æå–å¸§æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
                <div class="frames-settings" id="framesSettings" style="display: none;">
                    <div class="settings-row">
                        <div class="input-group">
                            <label for="fpsInput">æå–å¸§ç‡:</label>
                            <input type="number" id="fpsInput" value="1" min="0.1" max="30" step="0.1">
                            <span>fps</span>
                        </div>
                        <div class="input-group">
                            <label for="maxFramesInput">æœ€å¤§å¸§æ•°:</label>
                            <input type="number" id="maxFramesInput" value="30" min="1" max="60">
                            <span>å¸§</span>
                        </div>
                    </div>
                    
                    <!-- å¸§å°ºå¯¸è°ƒæ•´ -->
                    <div class="settings-row" style="margin-top: 15px;">
                        <div class="input-group">
                            <label for="frameWidthInput">å¸§å®½åº¦:</label>
                            <input type="number" id="frameWidthInput" placeholder="è‡ªåŠ¨" min="1" max="4096">
                            <span>px</span>
                        </div>
                        <div class="input-group">
                            <label for="frameHeightInput">å¸§é«˜åº¦:</label>
                            <input type="number" id="frameHeightInput" placeholder="è‡ªåŠ¨" min="1" max="4096">
                            <span>px</span>
                        </div>
                    </div>
                    
                    <p class="settings-info">
                        ğŸ’¡ æç¤ºï¼šFPS=1 è¡¨ç¤ºæ¯ç§’æå–1å¸§ï¼ŒFPS=0.5 è¡¨ç¤ºæ¯2ç§’æå–1å¸§ã€‚<br>
                        å¸§å°ºå¯¸ç•™ç©ºåˆ™ä½¿ç”¨åŸå§‹å°ºå¯¸ï¼Œåªå¡«ä¸€ä¸ªåˆ™æŒ‰æ¯”ä¾‹ç¼©æ”¾ã€‚è¾ƒå°çš„å¸§å°ºå¯¸å¯å‡å°‘Tokenæ¶ˆè€—ã€‚
                    </p>
                </div>
                
                <p class="settings-info" id="directModeInfo">
                    ğŸ’¡ ç›´æ¥å‘é€æ¨¡å¼ï¼šè§†é¢‘å°†å®Œæ•´å‘é€ç»™ Geminiï¼Œæ”¯æŒæ›´å¥½çš„æ—¶åºç†è§£ã€‚<br>
                    ğŸ“Š Token è®¡ç®—ï¼šé»˜è®¤åˆ†è¾¨ç‡ ~300 tokens/ç§’ï¼Œä½åˆ†è¾¨ç‡ ~100 tokens/ç§’<br>
                    â±ï¸ 2M ä¸Šä¸‹æ–‡çª—å£å¯å¤„ç†ï¼šé»˜è®¤ 2å°æ—¶ / ä½åˆ†è¾¨ç‡ 6å°æ—¶
                </p>
            </div>
        </div>
        
        <!-- äººè„¸è¯†åˆ«æ¨¡å¼ -->
        <div class="mode-content" id="faceMode">
            <!-- æˆ·ä¸»ç®¡ç†åŒºåŸŸ -->
            <div class="face-management-section">
                <h4>ğŸ‘¥ æˆ·ä¸»ç®¡ç†</h4>
                
                <!-- æ³¨å†Œæ–°æˆ·ä¸» -->
                <div class="register-face-area">
                    <div class="upload-area" id="faceUploadArea" style="padding: 20px;">
                        <div class="upload-icon" style="font-size: 32px;">ğŸ“·</div>
                        <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æˆ·ä¸»ç…§ç‰‡åˆ°æ­¤å¤„</p>
                        <p class="upload-text" style="font-size: 12px; color: #999;">è¯·ä¸Šä¼ åŒ…å«æ¸…æ™°äººè„¸çš„ç…§ç‰‡</p>
                    </div>
                    <input type="file" class="file-input" id="faceImageInput" accept="image/*">
                    
                    <div class="face-preview-container" id="facePreviewContainer" style="display: none;">
                        <img id="facePreview" src="" alt="æˆ·ä¸»ç…§ç‰‡é¢„è§ˆ" style="max-width: 200px; max-height: 200px; border-radius: 10px; margin: 10px auto; display: block;">
                    </div>
                    
                    <div class="input-group" style="margin-top: 15px; justify-content: center;">
                        <label for="faceNameInput">æˆ·ä¸»å§“å:</label>
                        <input type="text" id="faceNameInput" placeholder="è¯·è¾“å…¥å§“å" style="width: 180px;">
                        <button class="register-btn" id="registerFaceBtn" disabled>æ³¨å†Œæˆ·ä¸»</button>
                    </div>
                </div>
                
                <!-- å·²æ³¨å†Œæˆ·ä¸»åˆ—è¡¨ -->
                <div class="registered-faces-area">
                    <h5>ğŸ“‹ å·²æ³¨å†Œæˆ·ä¸» <button class="refresh-btn" id="refreshFacesBtn">ğŸ”„ åˆ·æ–°</button></h5>
                    <div class="faces-list" id="facesList">
                        <p class="no-faces-text">æš‚æ— å·²æ³¨å†Œæˆ·ä¸»</p>
                    </div>
                </div>
            </div>
            
            <!-- è§†é¢‘äººè„¸è¯†åˆ«åŒºåŸŸ -->
            <div class="face-recognition-section">
                <h4>ğŸ¬ è§†é¢‘äººè„¸è¯†åˆ«</h4>
                
                <div class="upload-area" id="faceVideoUploadArea">
                    <div class="upload-icon">ğŸ¬</div>
                    <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <p class="upload-text" style="font-size: 12px; color: #999;">æ”¯æŒ MP4, WebM, MOV, TS æ ¼å¼</p>
                </div>
                <input type="file" class="file-input" id="faceVideoInput" accept="video/*,.ts,.TS">
                
                <div class="preview-container" id="faceVideoPreviewContainer" style="display: none;">
                    <video class="video-preview" id="faceVideoPreview" controls style="max-height: 300px;"></video>
                    <p class="file-info" id="faceVideoInfo"></p>
                </div>
                
                <div class="face-recognition-settings">
                    <div class="settings-row">
                        <div class="input-group">
                            <label for="faceRecFpsInput">åˆ†æå¸§ç‡:</label>
                            <input type="number" id="faceRecFpsInput" value="1" min="0.5" max="5" step="0.5" style="width: 80px;">
                            <span>fps</span>
                        </div>
                        <div class="input-group">
                            <label for="faceRecMaxFramesInput">æœ€å¤§å¸§æ•°:</label>
                            <input type="number" id="faceRecMaxFramesInput" value="30" min="5" max="60" style="width: 80px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="useGeminiCheckbox">
                            <label for="useGeminiCheckbox">ç»“åˆ Gemini åœºæ™¯åˆ†æ</label>
                        </div>
                    </div>
                </div>
                
                <button class="submit-btn" id="startFaceRecBtn" disabled style="margin-top: 15px;">ğŸ” å¼€å§‹äººè„¸è¯†åˆ«</button>
            </div>
            
            <!-- äººè„¸è¯†åˆ«ç»“æœåŒºåŸŸ -->
            <div class="face-result-section" id="faceResultSection" style="display: none;">
                <h4>ğŸ“Š è¯†åˆ«ç»“æœ</h4>
                
                <div class="face-summary-box" id="faceSummaryBox">
                    <p id="faceSummaryText">-</p>
                </div>
                
                <!-- ç›¸ä¼¼åº¦ç»Ÿè®¡ -->
                <div class="similarity-stats-box" id="similarityStatsBox" style="display: none;">
                    <h5>ğŸ“ˆ ç›¸ä¼¼åº¦ç»Ÿè®¡</h5>
                    <div class="similarity-stats-grid" id="similarityStatsGrid"></div>
                </div>
                
                <!-- æ ‡æ³¨å¸§å›¾ç‰‡å±•ç¤º -->
                <div class="annotated-frames-box" id="annotatedFramesBox" style="display: none;">
                    <h5>ğŸ–¼ï¸ æ£€æµ‹ç»“æœé¢„è§ˆï¼ˆç‚¹å‡»æ”¾å¤§ï¼‰</h5>
                    <div class="annotated-frames-grid" id="annotatedFramesGrid"></div>
                </div>
                
                <div class="face-details-box">
                    <h5>ğŸ“‹ è¯¦ç»†è¯†åˆ«è®°å½•</h5>
                    <div class="face-details-list" id="faceDetailsList"></div>
                </div>
                
                <div class="gemini-analysis-box" id="geminiAnalysisBox" style="display: none;">
                    <h5>ğŸ¤– Gemini åœºæ™¯åˆ†æ</h5>
                    <div class="gemini-analysis-content" id="geminiAnalysisContent"></div>
                </div>
                
                <div class="processing-time-box" id="faceProcessingTimeBox">
                    <p id="faceProcessingTimeText">-</p>
                </div>
            </div>
        </div>
        
        <!-- è§†é¢‘æ ‡æ³¨æ¨¡å¼ -->
        <div class="mode-content" id="labelMode">
            <!-- æ·»åŠ æ ‡æ³¨äººç‰© -->
            <div class="label-section">
                <h4>ğŸ‘¥ æ·»åŠ æ ‡æ³¨äººç‰©</h4>
                <div class="add-person-area">
                    <div class="upload-area" id="labelPersonUploadArea" style="padding: 15px; display: inline-block; width: auto; min-width: 150px;">
                        <div class="upload-icon" style="font-size: 24px;">ğŸ“·</div>
                        <p class="upload-text" style="font-size: 12px;">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</p>
                    </div>
                    <input type="file" class="file-input" id="labelPersonImageInput" accept="image/*">
                    
                    <div class="person-input-group">
                        <img id="labelPersonPreview" src="" alt="" style="display: none; width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        <input type="text" id="labelPersonNameInput" placeholder="è¾“å…¥è‹±æ–‡åå­— (å¦‚: Tom)" style="width: 150px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <button class="add-person-btn" id="addLabelPersonBtn" disabled>æ·»åŠ </button>
                    </div>
                </div>
                
                <div class="persons-list-area">
                    <h5>å·²æ·»åŠ äººç‰©ï¼š<span id="labelPersonCount">0</span> äºº</h5>
                    <div class="persons-list" id="labelPersonsList">
                        <p class="no-persons-text">æš‚æœªæ·»åŠ äººç‰©</p>
                    </div>
                </div>
            </div>
            
            <!-- ä¸Šä¼ è§†é¢‘ -->
            <div class="label-section">
                <h4>ğŸ¬ ä¸Šä¼ è§†é¢‘</h4>
                <div class="upload-area" id="labelVideoUploadArea">
                    <div class="upload-icon">ğŸ¬</div>
                    <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <p class="upload-text" style="font-size: 12px; color: #999;">æ”¯æŒ MP4, WebM, MOV æ ¼å¼</p>
                </div>
                <input type="file" class="file-input" id="labelVideoInput" accept="video/*,.mp4,.webm,.mov">
                
                <div class="preview-container" id="labelVideoPreviewContainer" style="display: none;">
                    <video class="video-preview" id="labelVideoPreview" controls style="max-height: 250px;"></video>
                    <p class="file-info" id="labelVideoInfo"></p>
                </div>
            </div>
            
            <!-- æ ‡æ³¨è®¾ç½® -->
            <div class="label-section">
                <h4>âš™ï¸ æ ‡æ³¨è®¾ç½®</h4>
                <div class="label-settings">
                    <div class="input-group">
                        <label for="labelThresholdInput">ç›¸ä¼¼åº¦é˜ˆå€¼:</label>
                        <input type="number" id="labelThresholdInput" value="70" min="50" max="95" style="width: 80px;">
                        <span>%</span>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="labelShowUnknownCheckbox" checked>
                        <label for="labelShowUnknownCheckbox">æ˜¾ç¤ºæœªè¯†åˆ«äººè„¸ (Unknown)</label>
                    </div>
                </div>
                
                <button class="submit-btn" id="startLabelBtn" disabled style="margin-top: 15px;">ğŸš€ å¼€å§‹æ ‡æ³¨è§†é¢‘</button>
            </div>
            
            <!-- æ ‡æ³¨è¿›åº¦ -->
            <div class="label-section label-progress-section" id="labelProgressSection" style="display: none;">
                <h4>ğŸ“Š æ ‡æ³¨è¿›åº¦</h4>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="labelProgressBar" style="width: 0%;"></div>
                </div>
                <p class="progress-text" id="labelProgressText">å‡†å¤‡ä¸­...</p>
            </div>
            
            <!-- æ ‡æ³¨ç»“æœ -->
            <div class="label-section label-result-section" id="labelResultSection" style="display: none;">
                <h4>ğŸ“¹ æ ‡æ³¨ç»“æœ</h4>
                <div class="label-stats" id="labelStats"></div>
                <div class="download-area">
                    <a class="download-btn" id="labelDownloadBtn" href="#" download>â¬‡ï¸ ä¸‹è½½æ ‡æ³¨è§†é¢‘</a>
                </div>
                <p class="processing-time" id="labelProcessingTime"></p>
            </div>
        </div>
        
        <!-- å®æ—¶æ ‡æ³¨æ¨¡å¼ -->
        <div class="mode-content" id="realtimeMode">
            <!-- æ·»åŠ æ ‡æ³¨äººç‰© -->
            <div class="realtime-section">
                <h4>ğŸ‘¥ æ·»åŠ æ ‡æ³¨äººç‰©</h4>
                <div class="add-person-area">
                    <div class="upload-area" id="realtimePersonUploadArea" style="padding: 15px; display: inline-block; width: auto; min-width: 150px;">
                        <div class="upload-icon" style="font-size: 24px;">ğŸ“·</div>
                        <p class="upload-text" style="font-size: 12px;">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</p>
                    </div>
                    <input type="file" class="file-input" id="realtimePersonImageInput" accept="image/*">
                    
                    <div class="person-input-group">
                        <img id="realtimePersonPreview" src="" alt="" style="display: none; width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        <input type="text" id="realtimePersonNameInput" placeholder="è¾“å…¥è‹±æ–‡åå­— (å¦‚: Tom)" style="width: 150px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <button class="add-person-btn" id="addRealtimePersonBtn" disabled>æ·»åŠ </button>
                    </div>
                </div>
                
                <div class="persons-list-area">
                    <h5>å·²æ·»åŠ äººç‰©ï¼š<span id="realtimePersonCount">0</span> äºº</h5>
                    <div class="persons-list" id="realtimePersonsList">
                        <p class="no-persons-text">æš‚æœªæ·»åŠ äººç‰©</p>
                    </div>
                </div>
            </div>
            
            <!-- ä¸Šä¼ è§†é¢‘ -->
            <div class="realtime-section">
                <h4>ğŸ¬ ä¸Šä¼ è§†é¢‘</h4>
                <div class="upload-area" id="realtimeVideoUploadArea">
                    <div class="upload-icon">ğŸ¬</div>
                    <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <p class="upload-text" style="font-size: 12px; color: #999;">æ”¯æŒ MP4, WebM, MOV æ ¼å¼</p>
                </div>
                <input type="file" class="file-input" id="realtimeVideoInput" accept="video/*,.mp4,.webm,.mov">
                
                <div class="preview-container" id="realtimeVideoPreviewContainer" style="display: none;">
                    <video class="video-preview" id="realtimeVideoPreview" controls style="max-height: 200px;"></video>
                    <p class="file-info" id="realtimeVideoInfo"></p>
                </div>
            </div>
            
            <!-- GCloud è®¤è¯é…ç½®æŒ‰é’® -->
            <div class="realtime-section" style="padding: 15px;">
                <button class="submit-btn" id="openGcloudConfigBtn" style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); margin: 0; width: 100%;">
                    ğŸ” GCloud è®¤è¯é…ç½®
                </button>
                <p style="font-size: 11px; color: #888; margin-top: 8px; text-align: center;">å¯ç”¨ Gemini åœºæ™¯åˆ†æå‰ï¼Œè¯·å…ˆå®Œæˆè®¤è¯</p>
            </div>
            
            <!-- æ ‡æ³¨è®¾ç½® -->
            <div class="realtime-section">
                <h4>âš™ï¸ è®¾ç½®</h4>
                <div class="realtime-settings">
                    <div class="input-group">
                        <label for="realtimeThresholdInput">ç›¸ä¼¼åº¦é˜ˆå€¼:</label>
                        <input type="number" id="realtimeThresholdInput" value="70" min="50" max="95" style="width: 80px;">
                        <span>%</span>
                    </div>
                    <div class="input-group">
                        <label for="realtimeFpsInput">å¤„ç†å¸§ç‡:</label>
                        <input type="number" id="realtimeFpsInput" value="2" min="1" max="10" style="width: 80px;">
                        <span>fps</span>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="realtimeShowUnknownCheckbox" checked>
                        <label for="realtimeShowUnknownCheckbox">æ˜¾ç¤ºæœªè¯†åˆ«äººè„¸</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="realtimeGeminiCheckbox">
                        <label for="realtimeGeminiCheckbox">ğŸ¤– å¯ç”¨ Gemini åœºæ™¯åˆ†æ</label>
                    </div>
                </div>
                
                <!-- Gemini æç¤ºè¯è¾“å…¥åŒºåŸŸ -->
                <div id="realtimeGeminiPromptSection" style="display: none; margin-top: 15px; padding: 15px; background: #e8f4fd; border-radius: 10px; border: 1px solid #b3d7f5;">
                    <!-- è§†é¢‘å¤„ç†æ¨¡å¼é€‰æ‹© -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 14px; font-weight: 600; color: #1565c0; display: block; margin-bottom: 10px;">
                            âš™ï¸ è§†é¢‘å¤„ç†è®¾ç½®
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0;" id="realtimeModeFramesLabel">
                                <input type="radio" name="realtimeVideoMode" value="frames" id="realtimeModeFrames" checked style="margin-top: 3px;">
                                <div>
                                    <span style="font-weight: 500; color: #333;">ğŸ–¼ï¸ æå–å¸§æ¨¡å¼</span>
                                    <p style="font-size: 11px; color: #888; margin: 4px 0 0 0;">åŸºäº InsightFace è¯†åˆ«åˆ°çš„äººç‰©å…³é”®å¸§è¿›è¡Œåˆ†æï¼ˆæ¨èï¼‰</p>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0;" id="realtimeModeDirectLabel">
                                <input type="radio" name="realtimeVideoMode" value="direct" id="realtimeModeDirect" style="margin-top: 3px;">
                                <div>
                                    <span style="font-weight: 500; color: #333;">ğŸ¬ ç›´æ¥å‘é€è§†é¢‘</span>
                                    <p style="font-size: 11px; color: #888; margin: 4px 0 0 0;">å°†å®Œæ•´è§†é¢‘å‘é€ç»™ Gemini åˆ†æï¼ˆæ”¯æŒæ—¶åºç†è§£ï¼‰</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <label for="realtimeGeminiPrompt" style="font-size: 14px; font-weight: 600; color: #1565c0; display: block; margin-bottom: 8px;">
                        ğŸ“ Gemini åˆ†ææç¤ºè¯
                    </label>
                    <textarea id="realtimeGeminiPrompt" placeholder="è¯·æè¿°æ‚¨æƒ³è®© Gemini åˆ†æçš„å†…å®¹..." 
                        style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #90caf9; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;">è¯·åˆ†ææ¯ä¸ªæ ‡æ³¨äººç‰©åœ¨è§†é¢‘ä¸­çš„åœºæ™¯ï¼Œæè¿°ä»–ä»¬çš„åŠ¨ä½œã€å§¿æ€å’Œå‘¨å›´ç¯å¢ƒã€‚</textarea>
                    <p style="font-size: 11px; color: #666; margin-top: 8px;" id="realtimeGeminiHint">
                        ğŸ’¡ æç¤ºï¼šä¼šè‡ªåŠ¨ç»“åˆ InsightFace è¯†åˆ«åˆ°çš„äººç‰©ä¿¡æ¯è¿›è¡Œåˆ†æ
                    </p>
                </div>
                
                <button class="submit-btn" id="startRealtimeBtn" disabled style="margin-top: 15px;">â–¶ï¸ å¼€å§‹å®æ—¶æ ‡æ³¨</button>
                <button class="submit-btn" id="stopRealtimeBtn" style="margin-top: 15px; display: none; background: #dc3545;">â¹ï¸ åœæ­¢</button>
            </div>
            
            <!-- GCloud è®¤è¯é…ç½®å¼¹å‡ºæ¡† -->
            <div id="gcloudConfigModal" class="modal-overlay" style="display: none;">
                <div class="modal-content" style="max-width: 550px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                        <h3 style="margin: 0; color: #333;">ğŸ” GCloud è®¤è¯é…ç½®</h3>
                        <button id="closeGcloudConfigBtn" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; line-height: 1; padding: 0 5px;">&times;</button>
                    </div>
                    
                    <div class="modal-body">
                        <!-- Project ID è®¾ç½® -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-size: 14px; font-weight: 600; color: #333; display: block; margin-bottom: 8px;">ğŸ“ Project ID</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="gcloudProjectInput" placeholder="è¾“å…¥ Project IDï¼Œå¦‚: cloud-llm-preview2" 
                                       style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 13px;">
                                <button class="submit-btn" id="setProjectBtn" style="min-width: 100px; margin: 0;">
                                    ğŸ“‹ è®¾ç½®
                                </button>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰é’® -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="submit-btn" id="gcloudAuthBtn" style="flex: 1; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); margin: 0;">
                                ğŸ”‘ æ‰§è¡Œè®¤è¯
                            </button>
                            <button class="submit-btn" id="checkGcloudStatusBtn" style="flex: 1; background: linear-gradient(135deg, #34a853 0%, #4285f4 100%); margin: 0;">
                                âœ… æ£€æŸ¥çŠ¶æ€
                            </button>
                        </div>
                        
                        <!-- éªŒè¯ç è¾“å…¥åŒº -->
                        <div id="authCodeSection" style="display: none; margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                            <p style="font-size: 12px; color: #856404; margin: 0 0 10px 0; font-weight: 500;">ğŸ“‹ åœ¨æµè§ˆå™¨å®Œæˆç™»å½•åï¼Œå¤åˆ¶éªŒè¯ç ç²˜è´´åˆ°ä¸‹æ–¹</p>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="gcloudAuthCodeInput" placeholder="ç²˜è´´éªŒè¯ç " 
                                       style="flex: 1; padding: 12px; border: 2px solid #ffc107; border-radius: 8px; font-family: monospace; font-size: 14px;">
                                <button class="submit-btn" id="submitAuthCodeBtn" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: #333; min-width: 100px; margin: 0;">
                                    ğŸ“¤ æäº¤
                                </button>
                            </div>
                        </div>
                        
                        <!-- çŠ¶æ€ä¿¡æ¯ -->
                        <div id="gcloudStatusInfo" style="display: none; margin-bottom: 15px; padding: 12px; border-radius: 8px; font-size: 13px;"></div>
                        
                        <!-- æ‰§è¡Œæ—¥å¿— -->
                        <div>
                            <label style="font-size: 14px; font-weight: 600; color: #333; display: block; margin-bottom: 8px;">ğŸ“œ æ‰§è¡Œæ—¥å¿—</label>
                            <pre id="gcloudLogOutput" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-size: 12px; max-height: 200px; overflow-y: auto; margin: 0; white-space: pre-wrap; word-wrap: break-word;">ç­‰å¾…æ‰§è¡Œ...</pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å®æ—¶é¢„è§ˆåŒºåŸŸ -->
            <div class="realtime-section realtime-preview-section" id="realtimePreviewSection" style="display: none;">
                <h4>ğŸ–¥ï¸ å®æ—¶é¢„è§ˆ</h4>
                <div class="realtime-progress">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="realtimeProgressBar" style="width: 0%;"></div>
                    </div>
                    <p class="progress-text" id="realtimeProgressText">å‡†å¤‡ä¸­...</p>
                </div>
                <div class="realtime-display">
                    <img id="realtimeFrameDisplay" src="" alt="å®æ—¶é¢„è§ˆ" style="max-width: 100%; border-radius: 10px; display: none;">
                    <div class="realtime-info" id="realtimeInfo">
                        <span id="realtimeTimeInfo">æ—¶é—´: 0s</span>
                        <span id="realtimeFaceInfo">æ£€æµ‹åˆ°: 0 äºº</span>
                    </div>
                </div>
                <div class="realtime-faces-list" id="realtimeFacesList"></div>
                
                <!-- å®æ—¶JSONç»Ÿè®¡ -->
                <div class="realtime-json-stats" style="margin-top: 15px;">
                    <h5>ğŸ“Š å®æ—¶ç»Ÿè®¡</h5>
                    <pre id="realtimeJsonStats" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
                </div>
            </div>
            
            <!-- å®Œæˆç»Ÿè®¡ -->
            <div class="realtime-section realtime-complete-section" id="realtimeCompleteSection" style="display: none;">
                <h4>âœ… æ ‡æ³¨å®Œæˆ</h4>
                <div class="realtime-stats" id="realtimeStats"></div>
                
                <!-- Geminiäººç‰©åœºæ™¯åˆ†æç»“æœ -->
                <div id="realtimeGeminiResult" style="display: none; margin-top: 15px;">
                    <h5>ğŸ¤– Gemini äººç‰©åœºæ™¯åˆ†æ</h5>
                    
                    <!-- Token ç»Ÿè®¡ä¿¡æ¯ -->
                    <div id="realtimeTokenStats" style="display: none; margin-bottom: 15px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <div style="flex: 1; min-width: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 12px; opacity: 0.9;">Input Tokens</div>
                                <div style="font-size: 24px; font-weight: bold;" id="realtimeInputTokens">-</div>
                            </div>
                            <div style="flex: 1; min-width: 120px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 12px; opacity: 0.9;">Output Tokens</div>
                                <div style="font-size: 24px; font-weight: bold;" id="realtimeOutputTokens">-</div>
                            </div>
                            <div style="flex: 1; min-width: 120px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 12px; opacity: 0.9;">Total Tokens</div>
                                <div style="font-size: 24px; font-weight: bold;" id="realtimeTotalTokens">-</div>
                            </div>
                        </div>
                        <div style="background: #f0f4f8; padding: 10px 15px; border-radius: 8px; font-size: 13px; color: #555;">
                            <span>ğŸ“Š åˆ†æäººæ•°: <strong id="realtimePersonsAnalyzed">-</strong> äºº</span>
                            <span style="margin-left: 20px;">ğŸ–¼ï¸ åˆ†æå¸§æ•°: <strong id="realtimeFramesAnalyzed">-</strong> å¸§</span>
                        </div>
                    </div>
                    
                    <div id="realtimeGeminiContent" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #4285f4;"></div>
                </div>
            </div>
        </div>
        
        <!-- è§†é¢‘Cacheæ¨¡å¼ -->
        <div class="mode-content" id="cacheMode">
            <!-- æ·»åŠ æ ‡æ³¨äººç‰© -->
            <div class="cache-section" style="background: #fff3e0; border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 2px solid #ffb74d;">
                <h4 style="color: #e65100; margin-bottom: 15px;">ğŸ‘¥ æ·»åŠ æ ‡æ³¨äººç‰© <span style="font-size: 12px; color: #888;">(å¯é€‰)</span></h4>
                <div class="add-person-area">
                    <div class="upload-area" id="cachePersonUploadArea" style="padding: 15px; display: inline-block; width: auto; min-width: 150px;">
                        <div class="upload-icon" style="font-size: 24px;">ğŸ“·</div>
                        <p class="upload-text" style="font-size: 12px;">ç‚¹å‡»ä¸Šä¼ äººç‰©ç…§ç‰‡</p>
                    </div>
                    <input type="file" class="file-input" id="cachePersonImageInput" accept="image/*">
                    <input type="text" id="cachePersonNameInput" placeholder="è¾“å…¥äººç‰©åç§° (è‹±æ–‡)" style="padding: 10px; border: 2px solid #ffb74d; border-radius: 8px; margin-left: 10px; width: 150px;">
                    <button class="submit-btn" id="cacheAddPersonBtn" style="padding: 10px 20px; margin-left: 10px; background: linear-gradient(135deg, #ff9800, #f57c00);">æ·»åŠ </button>
                </div>
                <div id="cachePersonList" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
            
            <!-- ä¸Šä¼ è§†é¢‘å¹¶åˆ›å»º Cache -->
            <div class="cache-section" style="background: #e3f2fd; border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 2px solid #64b5f6;">
                <h4 style="color: #1565c0; margin-bottom: 15px;">ğŸ¬ ä¸Šä¼ è§†é¢‘å¹¶åˆ›å»º Cache</h4>
                <div class="upload-area" id="cacheVideoUploadArea" style="padding: 20px;">
                    <div class="upload-icon">ğŸ“¹</div>
                    <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <p class="upload-text" style="font-size: 12px; color: #999;">æ”¯æŒ MP4, AVI, MOV, WebM æ ¼å¼</p>
                </div>
                <input type="file" class="file-input" id="cacheVideoInput" accept="video/*">
                
                <div id="cacheVideoPreview" style="display: none; margin-top: 15px;">
                    <video id="cacheVideoPlayer" controls style="max-width: 100%; max-height: 300px; border-radius: 10px;"></video>
                    <p id="cacheVideoInfo" style="margin-top: 8px; font-size: 13px; color: #666;"></p>
                </div>
                
                <!-- åŸºç¡€åˆ†ææç¤ºè¯ -->
                <div style="margin-top: 15px;">
                    <label style="font-size: 14px; font-weight: 600; color: #1565c0; display: block; margin-bottom: 8px;">
                        ğŸ“ åŸºç¡€åˆ†ææç¤ºè¯ <span style="font-weight: normal; font-size: 11px; color: #888;">(ä¼šå†™å…¥ Cacheï¼Œå½±å“æ‰€æœ‰æŸ¥è¯¢)</span>
                    </label>
                    <textarea id="cacheBasePrompt" placeholder="ä¾‹å¦‚ï¼šè¯·é‡ç‚¹å…³æ³¨äººç‰©çš„è¡Œä¸ºåŠ¨ä½œã€äº’åŠ¨å…³ç³»ã€æƒ…ç»ªå˜åŒ–ç­‰..." 
                        style="width: 100%; min-height: 60px; padding: 12px; border: 2px solid #90caf9; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
                    <p style="font-size: 11px; color: #666; margin-top: 5px;">
                        ğŸ’¡ æ­¤æç¤ºè¯ä¼šä¸ InsightFace è¯†åˆ«ç»“æœä¸€èµ·å†™å…¥ Cacheï¼Œåç»­æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šåŸºäºæ­¤è¿›è¡Œåˆ†æ
                    </p>
                </div>
                
                <button class="submit-btn" id="createCacheBtn" disabled style="margin-top: 15px; background: linear-gradient(135deg, #2196f3, #1976d2);">ğŸ“¦ åˆ›å»º Cache</button>
                
                <!-- Cache çŠ¶æ€æ˜¾ç¤º -->
                <div id="cacheStatusArea" style="display: none; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border: 2px solid #81c784;">
                    <h5 style="color: #2e7d32; margin-bottom: 10px;">âœ… Cache å·²åˆ›å»º</h5>
                    <p style="font-size: 13px; margin: 5px 0;"><strong>Cache ID:</strong> <span id="cacheIdDisplay">-</span></p>
                    <p style="font-size: 13px; margin: 5px 0;"><strong>åˆ›å»ºæ—¶é—´:</strong> <span id="cacheCreatedAt">-</span></p>
                    <p style="font-size: 13px; margin: 5px 0;"><strong>è¿‡æœŸæ—¶é—´:</strong> <span id="cacheExpiresAt">-</span></p>
                    <p style="font-size: 13px; margin: 5px 0;"><strong>ç¼“å­˜ Token:</strong> <span id="cacheTotalTokens">-</span></p>
                    <button class="submit-btn" id="deleteCacheBtn" style="margin-top: 10px; padding: 8px 15px; background: #ef5350; font-size: 13px;">ğŸ—‘ï¸ åˆ é™¤ Cache</button>
                </div>
            </div>
            
            <!-- æŸ¥è¯¢åˆ†æ -->
            <div class="cache-section" style="background: #f3e5f5; border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 2px solid #ba68c8;">
                <h4 style="color: #7b1fa2; margin-bottom: 15px;">ğŸ’¬ æŸ¥è¯¢åˆ†æ <span style="font-size: 12px; color: #888;">(å¯å¤šæ¬¡æŸ¥è¯¢ï¼Œå¤ç”¨ Cache)</span></h4>
                
                <textarea id="cacheQueryInput" placeholder="è¯·è¾“å…¥æ‚¨çš„åˆ†æé—®é¢˜ï¼Œä¾‹å¦‚ï¼šè¯·åˆ†æè§†é¢‘ä¸­äººç‰©çš„è¡Œä¸ºè½¨è¿¹..." 
                    style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #ce93d8; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
                
                <button class="submit-btn" id="sendCacheQueryBtn" disabled style="margin-top: 10px; background: linear-gradient(135deg, #9c27b0, #7b1fa2);">ğŸ” å‘é€æŸ¥è¯¢</button>
                
                <!-- Token ç»Ÿè®¡ -->
                <div id="cacheTokenStats" style="display: none; margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 8px; border: 1px solid #81c784;">
                    <h5 style="color: #2e7d32; margin-bottom: 10px;">ğŸ“Š Token ç»Ÿè®¡ & è´¹ç”¨èŠ‚çœ</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                        <div style="background: #c8e6c9; padding: 8px; border-radius: 6px;">
                            <div style="color: #1b5e20; font-weight: 600;">ğŸ“¦ è§†é¢‘ç¼“å­˜ (ä½è´¹ç‡)</div>
                            <div><strong id="statCachedTokens">-</strong> Token</div>
                        </div>
                        <div style="background: #fff3e0; padding: 8px; border-radius: 6px;">
                            <div style="color: #e65100; font-weight: 600;">ğŸ“ æœ¬æ¬¡é—®é¢˜ (æ­£å¸¸è´¹ç‡)</div>
                            <div><strong id="statNewInputTokens">-</strong> Token</div>
                        </div>
                        <div style="background: #e3f2fd; padding: 8px; border-radius: 6px;">
                            <div style="color: #1565c0; font-weight: 600;">ğŸ“¤ è¾“å‡º</div>
                            <div><strong id="statOutputTokens">-</strong> Token</div>
                        </div>
                        <div style="background: #f3e5f5; padding: 8px; border-radius: 6px;">
                            <div style="color: #7b1fa2; font-weight: 600;">ğŸ’° æœ¬æ¬¡èŠ‚çœ</div>
                            <div><strong id="statSavedTokens">-</strong> Token <span style="color: #4caf50;">âœ“</span></div>
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #666; margin-top: 10px; margin-bottom: 0;">
                        ğŸ’¡ ä¼ ç»Ÿæ–¹å¼æ¯æ¬¡æŸ¥è¯¢éƒ½è¦è®¡ç®—è§†é¢‘ Token (<span id="statCachedTokensRef">-</span>)ï¼Œä½¿ç”¨ Cache ååªè®¡ç®—é—®é¢˜ Token (<span id="statNewInputTokensRef">-</span>)
                    </p>
                </div>
                
                <!-- åˆ†æç»“æœ -->
                <div id="cacheResultArea" style="display: none; margin-top: 20px;">
                    <h5 style="color: #7b1fa2; margin-bottom: 10px;">ğŸ“ åˆ†æç»“æœ</h5>
                    <div id="cacheResultContent" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0; white-space: pre-wrap; line-height: 1.6;"></div>
                </div>
                
                <!-- æŸ¥è¯¢å†å² -->
                <div id="cacheQueryHistory" style="margin-top: 20px;">
                    <h5 style="color: #666; margin-bottom: 10px;">ğŸ“œ æŸ¥è¯¢å†å²</h5>
                    <div id="cacheHistoryList" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <!-- ä½¿ç”¨è¯´æ˜ -->
            <div style="background: #fffde7; border-radius: 10px; padding: 15px; border: 1px solid #fff59d;">
                <h5 style="color: #f57f17; margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h5>
                <ul style="font-size: 13px; color: #666; margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li><strong>è´¹ç”¨èŠ‚çœ</strong>ï¼šè§†é¢‘å†…å®¹åˆ›å»º Cache åï¼Œåç»­æŸ¥è¯¢åªè®¡ç®—é—®é¢˜ Tokenï¼Œä¸é‡å¤è®¡ç®—è§†é¢‘ Token</li>
                    <li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šéœ€è¦å¯¹åŒä¸€è§†é¢‘è¿›è¡Œå¤šæ¬¡ä¸åŒè§’åº¦åˆ†ææ—¶</li>
                    <li><strong>æœ‰æ•ˆæœŸ</strong>ï¼šCache é»˜è®¤ 1 å°æ—¶æœ‰æ•ˆï¼Œè¿‡æœŸåéœ€é‡æ–°åˆ›å»º</li>
                    <li><strong>Owner æ ‡æ³¨</strong>ï¼šæ·»åŠ äººç‰©ç…§ç‰‡å¯å¸®åŠ© Gemini è¯†åˆ«ç‰¹å®šäººç‰©</li>
                </ul>
            </div>
        </div>
        
        <!-- é™Œç”Ÿäººæ£€æµ‹æ¨¡å¼ -->
        <div class="mode-content" id="strangerMode">
            <!-- æ·»åŠ æˆ·ä¸»ç…§ç‰‡ -->
            <div class="stranger-section" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 2px solid #ff9800;">
                <h4 style="color: #e65100; margin-bottom: 15px;">ğŸ‘¥ æ·»åŠ æˆ·ä¸»ç…§ç‰‡</h4>
                <div class="add-person-area">
                    <div class="upload-area" id="strangerPersonUploadArea" style="padding: 15px; display: inline-block; width: auto; min-width: 150px;">
                        <div class="upload-icon" style="font-size: 24px;">ğŸ“·</div>
                        <p class="upload-text" style="font-size: 12px;">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</p>
                    </div>
                    <input type="file" class="file-input" id="strangerPersonImageInput" accept="image/*">
                    
                    <div class="person-input-group">
                        <img id="strangerPersonPreview" src="" alt="" style="display: none; width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        <input type="text" id="strangerPersonNameInput" placeholder="è¾“å…¥æˆ·ä¸»åç§°" style="width: 150px; padding: 10px; border: 2px solid #ff9800; border-radius: 8px;">
                        <button class="add-person-btn" id="addStrangerPersonBtn" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">æ·»åŠ </button>
                    </div>
                </div>
                
                <div class="persons-list-area" style="margin-top: 15px;">
                    <h5>å·²æ·»åŠ æˆ·ä¸»ï¼š<span id="strangerPersonCount">0</span> äºº</h5>
                    <div class="persons-list" id="strangerPersonsList">
                        <p class="no-persons-text">æš‚æœªæ·»åŠ æˆ·ä¸»ç…§ç‰‡</p>
                    </div>
                </div>
            </div>
            
            <!-- ä¸Šä¼ è§†é¢‘ -->
            <div class="stranger-section" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 2px solid #2196f3;">
                <h4 style="color: #1565c0; margin-bottom: 15px;">ğŸ“¹ ä¸Šä¼ è§†é¢‘</h4>
                <div class="upload-area" id="strangerVideoUploadArea">
                    <div class="upload-icon">ğŸ¬</div>
                    <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <p class="upload-text" style="font-size: 12px; color: #999;">æ”¯æŒ MP4, WebM, MOV æ ¼å¼</p>
                </div>
                <input type="file" class="file-input" id="strangerVideoInput" accept="video/*,.mp4,.webm,.mov">
                
                <div class="preview-container" id="strangerVideoPreviewContainer" style="display: none;">
                    <video class="video-preview" id="strangerVideoPreview" controls style="max-height: 250px;"></video>
                    <p class="file-info" id="strangerVideoInfo"></p>
                </div>
            </div>
            
            <!-- åˆ†ææ¨¡å¼é€‰æ‹© -->
            <div class="stranger-section" style="background: #f5f5f5; border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 2px solid #9e9e9e;">
                <h4 style="color: #424242; margin-bottom: 15px;">âš™ï¸ åˆ†æè®¾ç½®</h4>
                
                <div class="radio-group" style="margin-bottom: 20px;">
                    <label class="radio-label" style="border-color: #2196f3; background: #e3f2fd;">
                        <input type="radio" name="strangerAnalyzeMode" value="direct" id="strangerModeDirectRadio" checked>
                        <span class="radio-text">ğŸ¬ ç›´æ¥åˆ†æ</span>
                        <span class="radio-desc">å°†è§†é¢‘å’Œæˆ·ä¸»ç…§ç‰‡ä¸€èµ·å‘é€ç»™ Gemini åˆ†æ</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="strangerAnalyzeMode" value="cache" id="strangerModeCacheRadio">
                        <span class="radio-text">ğŸ“¦ Cache æ¨¡å¼</span>
                        <span class="radio-desc">å°†æˆ·ä¸»ä¿¡æ¯å†™å…¥ Cacheï¼Œå¯å¤šæ¬¡åˆ†æä¸åŒè§†é¢‘</span>
                    </label>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 14px; font-weight: 600; color: #333; display: block; margin-bottom: 8px;">
                        ğŸ“ åˆ†ææç¤ºè¯ <span style="font-weight: normal; color: #888;">(å¯è‡ªå®šä¹‰)</span>
                    </label>
                    <textarea id="strangerPromptInput" placeholder="è¯·åˆ†æè§†é¢‘ä¸­æ˜¯å¦æœ‰é™Œç”Ÿäººå‡ºç°ï¼Œå¹¶æè¿°åœºæ™¯..." 
                        style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #9e9e9e; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;">è¯·åˆ¤æ–­è§†é¢‘ä¸­æ˜¯å¦æœ‰é™Œç”Ÿäººï¼ˆæœªåœ¨æˆ·ä¸»ç…§ç‰‡ä¸­å‡ºç°çš„äººï¼‰ï¼Œè¯¦ç»†æè¿°æ¯ä¸ªäººçš„è¡Œä¸ºå’Œåœºæ™¯ã€‚</textarea>
                </div>
                
                <button class="submit-btn" id="startStrangerAnalyzeBtn" disabled style="background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%);">ğŸ” å¼€å§‹é™Œç”Ÿäººæ£€æµ‹</button>
            </div>
            
            <!-- Cache çŠ¶æ€ï¼ˆä»… Cache æ¨¡å¼æ˜¾ç¤ºï¼‰-->
            <div class="stranger-section" id="strangerCacheStatusSection" style="display: none; background: #e8f5e9; border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 2px solid #4caf50;">
                <h5 style="color: #2e7d32; margin-bottom: 10px;">âœ… Cache å·²åˆ›å»º</h5>
                <p style="font-size: 13px; margin: 5px 0;"><strong>Cache ID:</strong> <span id="strangerCacheId">-</span></p>
                <p style="font-size: 13px; margin: 5px 0;"><strong>æˆ·ä¸»æ•°é‡:</strong> <span id="strangerCacheOwnerCount">-</span></p>
                <p style="font-size: 13px; margin: 5px 0;"><strong>è¿‡æœŸæ—¶é—´:</strong> <span id="strangerCacheExpires">-</span></p>
                <button class="submit-btn" id="deleteStrangerCacheBtn" style="margin-top: 10px; padding: 8px 15px; background: #ef5350; font-size: 13px;">ğŸ—‘ï¸ åˆ é™¤ Cache</button>
            </div>
            
            <!-- åˆ†æè¿›åº¦ -->
            <div class="stranger-section" id="strangerProgressSection" style="display: none; background: #fff; border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 2px solid #2196f3;">
                <h4 style="color: #1565c0; margin-bottom: 15px;">ğŸ“Š åˆ†æè¿›åº¦</h4>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="strangerProgressBar" style="width: 0%;"></div>
                </div>
                <p class="progress-text" id="strangerProgressText">å‡†å¤‡ä¸­...</p>
            </div>
            
            <!-- æ£€æµ‹ç»“æœ -->
            <div class="stranger-section" id="strangerResultSection" style="display: none; background: #fff; border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 2px solid #4caf50;">
                <h4 style="color: #2e7d32; margin-bottom: 20px;">ğŸ“Š æ£€æµ‹ç»“æœ</h4>
                
                <!-- è­¦å‘Š/å®‰å…¨æç¤º -->
                <div id="strangerAlertBox" style="padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <p id="strangerAlertText" style="font-size: 18px; font-weight: bold; margin: 0;"></p>
                </div>
                
                <!-- Token ç»Ÿè®¡ -->
                <div class="token-info" style="margin-bottom: 20px;">
                    <div class="token-box">
                        <div class="token-label">Input Tokens</div>
                        <div class="token-value" id="strangerInputTokens">-</div>
                    </div>
                    <div class="token-box">
                        <div class="token-label">Output Tokens</div>
                        <div class="token-value" id="strangerOutputTokens">-</div>
                    </div>
                    <div class="token-box">
                        <div class="token-label">å¤„ç†è€—æ—¶</div>
                        <div class="token-value" id="strangerProcessingTime">-</div>
                    </div>
                </div>
                
                <!-- è¯¦ç»† Token ä¿¡æ¯ -->
                <div class="token-details-section" id="strangerTokenDetailsSection" style="display: none; margin-bottom: 20px;">
                    <h5>ğŸ“Š Token è¯¦ç»†ä¿¡æ¯</h5>
                    <div class="token-details-grid">
                        <!-- Input Token è¯¦æƒ… -->
                        <div class="token-detail-card">
                            <h6>ğŸ“¥ Input Tokens è¯¦æƒ…</h6>
                            <div class="token-detail-item">
                                <span class="token-detail-label">ğŸ“ Text</span>
                                <span class="token-detail-value" id="strangerInputTextTokens">0</span>
                            </div>
                            <div class="token-detail-item">
                                <span class="token-detail-label">ğŸ–¼ï¸ Image</span>
                                <span class="token-detail-value highlight" id="strangerInputImageTokens">0</span>
                            </div>
                            <div class="token-detail-item">
                                <span class="token-detail-label">ğŸ¬ Video</span>
                                <span class="token-detail-value highlight" id="strangerInputVideoTokens">0</span>
                            </div>
                            <div class="token-detail-item">
                                <span class="token-detail-label">ğŸ”Š Audio</span>
                                <span class="token-detail-value" id="strangerInputAudioTokens">0</span>
                            </div>
                        </div>
                        
                        <!-- Output Token è¯¦æƒ… -->
                        <div class="token-detail-card">
                            <h6>ğŸ“¤ Output Tokens è¯¦æƒ…</h6>
                            <div class="token-detail-item">
                                <span class="token-detail-label">ğŸ“ Text</span>
                                <span class="token-detail-value" id="strangerOutputTextTokens">0</span>
                            </div>
                            <div class="token-detail-item">
                                <span class="token-detail-label">ğŸ§  Thinking</span>
                                <span class="token-detail-value thinking" id="strangerThinkingTokens">0</span>
                            </div>
                        </div>
                        
                        <!-- ç¼“å­˜ Token è¯¦æƒ… -->
                        <div class="token-detail-card">
                            <h6>ğŸ’¾ ç¼“å­˜ Tokens</h6>
                            <div class="token-detail-item">
                                <span class="token-detail-label">Cached Content</span>
                                <span class="token-detail-value" id="strangerCachedTokens">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¯¦ç»†åˆ†æ -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #2e7d32;">
                    <h5 style="margin-bottom: 10px; color: #333;">ğŸ¤– Gemini åˆ†æç»“æœ</h5>
                    <div id="strangerAnalysisContent" style="white-space: pre-wrap; line-height: 1.8; color: #555;"></div>
                </div>
            </div>
            
            <!-- ä½¿ç”¨è¯´æ˜ -->
            <div style="background: #fffde7; border-radius: 10px; padding: 15px; border: 1px solid #fff59d;">
                <h5 style="color: #f57f17; margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h5>
                <ul style="font-size: 13px; color: #666; margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li><strong>çº¯ Gemini è¯†åˆ«</strong>ï¼šå°†æˆ·ä¸»ç…§ç‰‡å’Œè§†é¢‘ä¸€èµ·å‘é€ç»™ Geminiï¼Œç”± AI åˆ¤æ–­æ˜¯å¦æœ‰é™Œç”Ÿäºº</li>
                    <li><strong>ç›´æ¥åˆ†ææ¨¡å¼</strong>ï¼šé€‚åˆå•æ¬¡åˆ†æï¼Œæ¯æ¬¡éƒ½å‘é€å®Œæ•´æ•°æ®</li>
                    <li><strong>Cache æ¨¡å¼</strong>ï¼šé€‚åˆç”¨åŒä¸€æ‰¹æˆ·ä¸»ç…§ç‰‡åˆ†æå¤šä¸ªè§†é¢‘ï¼ŒèŠ‚çœé‡å¤ä¼ è¾“</li>
                    <li><strong>è¯†åˆ«ç²¾åº¦</strong>ï¼šä¾èµ– Gemini çš„è§†è§‰ç†è§£èƒ½åŠ›ï¼Œé€‚åˆå¯¹äººè„¸æœ‰ä¸€å®šå·®å¼‚çš„åœºæ™¯</li>
                </ul>
            </div>
        </div>
        
        <div class="prompt-section">
            <label for="promptInput">æç¤ºè¯ (Prompt)</label>
            <textarea class="prompt-input" id="promptInput" placeholder="è¯·æè¿°æ‚¨æƒ³è®© AI åˆ†æçš„å†…å®¹">è¯·æè¿°è¿™ä¸ªå†…å®¹</textarea>
        </div>
        
        <button class="submit-btn" id="submitBtn" disabled>æäº¤åˆ†æ</button>
        <button class="submit-btn" id="submitLangchainBtn" disabled style="margin-top: 10px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ğŸ”— ä½¿ç”¨ LangChain åˆ†æ (media_resolution=medium)</button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="result-section" id="resultSection">
            <h3 class="result-title">ğŸ“Š åˆ†æç»“æœ</h3>
            <div class="token-info">
                <div class="token-box">
                    <div class="token-label">Input Tokens</div>
                    <div class="token-value" id="inputTokens">-</div>
                </div>
                <div class="token-box">
                    <div class="token-label">Output Tokens</div>
                    <div class="token-value" id="outputTokens">-</div>
                </div>
                <div class="token-box">
                    <div class="token-label">Total Tokens</div>
                    <div class="token-value" id="totalTokens">-</div>
                </div>
            </div>
            
            <!-- è¯¦ç»† Token ä¿¡æ¯ -->
            <div class="token-details-section" id="tokenDetailsSection" style="display: none;">
                <h5>ğŸ“Š Token è¯¦ç»†ä¿¡æ¯</h5>
                <div class="token-details-grid">
                    <!-- Input Token è¯¦æƒ… -->
                    <div class="token-detail-card">
                        <h6>ğŸ“¥ Input Tokens è¯¦æƒ…</h6>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ“ Text</span>
                            <span class="token-detail-value" id="inputTextTokens">0</span>
                        </div>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ–¼ï¸ Image</span>
                            <span class="token-detail-value highlight" id="inputImageTokens">0</span>
                        </div>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ¬ Video</span>
                            <span class="token-detail-value highlight" id="inputVideoTokens">0</span>
                        </div>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ”Š Audio</span>
                            <span class="token-detail-value" id="inputAudioTokens">0</span>
                        </div>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ’¾ Cached</span>
                            <span class="token-detail-value" id="inputCachedTokens">0</span>
                        </div>
                    </div>
                    
                    <!-- Output Token è¯¦æƒ… -->
                    <div class="token-detail-card">
                        <h6>ğŸ“¤ Output Tokens è¯¦æƒ…</h6>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ“ Text</span>
                            <span class="token-detail-value" id="outputTextTokens">0</span>
                        </div>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ–¼ï¸ Image</span>
                            <span class="token-detail-value" id="outputImageTokens">0</span>
                        </div>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ¬ Video</span>
                            <span class="token-detail-value" id="outputVideoTokens">0</span>
                        </div>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ”Š Audio</span>
                            <span class="token-detail-value" id="outputAudioTokens">0</span>
                        </div>
                    </div>
                    
                    <!-- ç‰¹æ®Š Token è¯¦æƒ… -->
                    <div class="token-detail-card">
                        <h6>âš¡ ç‰¹æ®Š Tokens</h6>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ§  Thinking</span>
                            <span class="token-detail-value thinking" id="thinkingTokens">0</span>
                        </div>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ”§ Tool Use</span>
                            <span class="token-detail-value tool" id="toolUseTokens">0</span>
                        </div>
                        <div class="token-detail-item">
                            <span class="token-detail-label">ğŸ’¾ Cached Content</span>
                            <span class="token-detail-value" id="cachedContentTokens">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å›¾ç‰‡ç»“æœä¿¡æ¯ -->
            <div class="info-box" id="imageSizeInfo" style="display: none;">
                <h5>ğŸ“ å›¾ç‰‡å°ºå¯¸ä¿¡æ¯</h5>
                <p id="originalSizeText">åŸå§‹å°ºå¯¸: -</p>
                <p id="processedSizeText">å¤„ç†åå°ºå¯¸: -</p>
                <p id="resizedText">æ˜¯å¦è°ƒæ•´: -</p>
            </div>
            
            <!-- è§†é¢‘ç»“æœä¿¡æ¯ -->
            <div class="info-box" id="videoResultInfo" style="display: none;">
                <h5>ğŸ¬ è§†é¢‘ä¿¡æ¯</h5>
                <p id="videoDimensionsText">è§†é¢‘å°ºå¯¸: -</p>
                <p id="videoDurationText">è§†é¢‘æ—¶é•¿: -</p>
                <p id="videoOriginalFpsText">åŸå§‹å¸§ç‡: -</p>
                <p id="videoExtractFpsText">æå–å¸§ç‡: -</p>
                <p id="framesExtractedText">æå–å¸§æ•°: -</p>
            </div>
            
            <!-- å¤„ç†åçš„å›¾ç‰‡ -->
            <div class="processed-media-section" id="processedImageSection" style="display: none;">
                <h5>ğŸ–¼ï¸ å‘é€ç»™ Gemini çš„å›¾ç‰‡</h5>
                <img id="processedImageResult" src="" alt="å¤„ç†åçš„å›¾ç‰‡">
            </div>
            
            <!-- è§†é¢‘å¸§é¢„è§ˆ -->
            <div class="processed-media-section" id="framesPreviewSection" style="display: none;">
                <h5>ğŸï¸ æå–çš„è§†é¢‘å¸§é¢„è§ˆï¼ˆå‰6å¸§ï¼‰</h5>
                <div class="frames-preview" id="framesPreview"></div>
            </div>
            
            <h4 style="margin-bottom: 10px; color: #333;">AI å“åº”å†…å®¹ï¼š</h4>
            <div class="response-content" id="responseContent"></div>
        </div>
    </div>
    
    <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">
            <span class="image-modal-close" id="imageModalClose">&times;</span>
            <img class="image-modal-img" id="imageModalImg" src="" alt="æ”¾å¤§å›¾ç‰‡">
            <div class="image-modal-info" id="imageModalInfo"></div>
        </div>
    </div>
    
    <script>
        // æ¨¡å¼åˆ‡æ¢
        const modeTabs = document.querySelectorAll('.mode-tab');
        const modeContents = document.querySelectorAll('.mode-content');
        let currentMode = 'image';
        
        modeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const mode = tab.dataset.mode;
                currentMode = mode;
                
                modeTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                modeContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === mode + 'Mode') {
                        content.classList.add('active');
                    }
                });
                
                // æ›´æ–°æç¤ºè¯å’ŒæŒ‰é’®æ˜¾ç¤º
                const promptSection = document.querySelector('.prompt-section');
                const submitBtnEl = document.getElementById('submitBtn');
                const submitLangchainBtnEl = document.getElementById('submitLangchainBtn');
                const resultSectionEl = document.getElementById('resultSection');
                
                if (mode === 'image') {
                    document.getElementById('promptInput').placeholder = 'è¯·æè¿°æ‚¨æƒ³è®© AI åˆ†æçš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šè¯·æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹';
                    promptSection.style.display = 'block';
                    submitBtnEl.style.display = 'block';
                    submitLangchainBtnEl.style.display = 'block';
                    resultSectionEl.style.display = '';
                } else if (mode === 'video') {
                    document.getElementById('promptInput').placeholder = 'è¯·æè¿°æ‚¨æƒ³è®© AI åˆ†æçš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šè¯·æè¿°è¿™ä¸ªè§†é¢‘çš„å†…å®¹';
                    promptSection.style.display = 'block';
                    submitBtnEl.style.display = 'block';
                    submitLangchainBtnEl.style.display = 'none';
                    resultSectionEl.style.display = '';
                } else if (mode === 'face') {
                    // äººè„¸è¯†åˆ«æ¨¡å¼ï¼šéšè—åŸæœ‰çš„æç¤ºè¯å’Œæäº¤æŒ‰é’®
                    promptSection.style.display = 'none';
                    submitBtnEl.style.display = 'none';
                    submitLangchainBtnEl.style.display = 'none';
                    resultSectionEl.style.display = 'none';
                    // åŠ è½½æˆ·ä¸»åˆ—è¡¨
                    if (typeof loadFacesList === 'function') {
                        loadFacesList();
                    }
                } else if (mode === 'label') {
                    // è§†é¢‘æ ‡æ³¨æ¨¡å¼ï¼šéšè—åŸæœ‰çš„æç¤ºè¯å’Œæäº¤æŒ‰é’®
                    promptSection.style.display = 'none';
                    submitBtnEl.style.display = 'none';
                    submitLangchainBtnEl.style.display = 'none';
                    resultSectionEl.style.display = 'none';
                } else if (mode === 'realtime') {
                    // å®æ—¶æ ‡æ³¨æ¨¡å¼ï¼šéšè—åŸæœ‰çš„æç¤ºè¯å’Œæäº¤æŒ‰é’®
                    promptSection.style.display = 'none';
                    submitBtnEl.style.display = 'none';
                    submitLangchainBtnEl.style.display = 'none';
                    resultSectionEl.style.display = 'none';
                } else if (mode === 'cache') {
                    // è§†é¢‘Cacheæ¨¡å¼ï¼šéšè—åŸæœ‰çš„æç¤ºè¯å’Œæäº¤æŒ‰é’®
                    promptSection.style.display = 'none';
                    submitBtnEl.style.display = 'none';
                    submitLangchainBtnEl.style.display = 'none';
                    resultSectionEl.style.display = 'none';
                }
                
                // é‡ç½®æäº¤æŒ‰é’®çŠ¶æ€
                updateSubmitButton();
                
                // æ›´æ–° Media Resolution æ˜¾ç¤º
                updateMediaResolutionVisibility();
            });
        });
        
        // å›¾ç‰‡ç›¸å…³å˜é‡
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageFileInput = document.getElementById('imageFileInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const imageInfo = document.getElementById('imageInfo');
        const imageSettings = document.getElementById('imageSettings');
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');
        const keepRatio = document.getElementById('keepRatio');
        const resizeInfo = document.getElementById('resizeInfo');
        const previewResizeBtn = document.getElementById('previewResizeBtn');
        const resizedPreviewContainer = document.getElementById('resizedPreviewContainer');
        const resizedImagePreview = document.getElementById('resizedImagePreview');
        const resizedInfoText = document.getElementById('resizedInfo');
        
        let selectedImageFile = null;
        let originalWidth = 0;
        let originalHeight = 0;
        let aspectRatio = 1;
        let originalImageData = null;
        
        // è§†é¢‘ç›¸å…³å˜é‡
        const videoUploadArea = document.getElementById('videoUploadArea');
        const videoFileInput = document.getElementById('videoFileInput');
        const videoPreviewContainer = document.getElementById('videoPreviewContainer');
        const videoPreview = document.getElementById('videoPreview');
        const videoInfo = document.getElementById('videoInfo');
        const videoSettings = document.getElementById('videoSettings');
        const fpsInput = document.getElementById('fpsInput');
        const maxFramesInput = document.getElementById('maxFramesInput');
        const modeDirectRadio = document.getElementById('modeDirectRadio');
        const modeFramesRadio = document.getElementById('modeFramesRadio');
        const framesSettings = document.getElementById('framesSettings');
        const directModeInfo = document.getElementById('directModeInfo');
        const frameWidthInput = document.getElementById('frameWidthInput');
        const frameHeightInput = document.getElementById('frameHeightInput');
        
        let selectedVideoFile = null;
        
        // è§†é¢‘æ¨¡å¼åˆ‡æ¢
        modeDirectRadio.addEventListener('change', () => {
            if (modeDirectRadio.checked) {
                framesSettings.style.display = 'none';
                directModeInfo.style.display = 'block';
            }
        });
        
        modeFramesRadio.addEventListener('change', () => {
            if (modeFramesRadio.checked) {
                framesSettings.style.display = 'block';
                directModeInfo.style.display = 'none';
            }
        });
        
        // é€šç”¨å˜é‡
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const resultSection = document.getElementById('resultSection');
        const errorMessage = document.getElementById('errorMessage');
        const modelSelect = document.getElementById('modelSelect');
        const mediaResolutionSelector = document.getElementById('mediaResolutionSelector');
        const mediaResolutionSelect = document.getElementById('mediaResolutionSelect');
        
        // è§†é¢‘é«˜çº§è®¾ç½®å…ƒç´ 
        const videoAdvancedSettings = document.getElementById('videoAdvancedSettings');
        const videoFpsInput = document.getElementById('videoFpsInput');
        const startOffsetInput = document.getElementById('startOffsetInput');
        const endOffsetInput = document.getElementById('endOffsetInput');
        
        // æ›´æ–°è§†é¢‘é«˜çº§è®¾ç½®æ˜¾ç¤ºçŠ¶æ€
        function updateMediaResolutionVisibility() {
            // è§†é¢‘æ¨¡å¼ä¸‹æ˜¾ç¤ºé«˜çº§è®¾ç½®
            if (currentMode === 'video') {
                videoAdvancedSettings.style.display = 'block';
                videoAdvancedSettings.classList.add('show');
            } else {
                videoAdvancedSettings.style.display = 'none';
                videoAdvancedSettings.classList.remove('show');
            }
        }
        
        // æ¨¡å‹é€‰æ‹©å˜åŒ–æ—¶
        modelSelect.addEventListener('change', () => {
            updateMediaResolutionVisibility();
        });
        
        // å›¾ç‰‡ä¸Šä¼ äº‹ä»¶
        imageUploadArea.addEventListener('click', () => imageFileInput.click());
        
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('dragover');
        });
        
        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('dragover');
        });
        
        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFile(files[0]);
            }
        });
        
        imageFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });
        
        // è§†é¢‘ä¸Šä¼ äº‹ä»¶
        videoUploadArea.addEventListener('click', () => videoFileInput.click());
        
        videoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            videoUploadArea.classList.add('dragover');
        });
        
        videoUploadArea.addEventListener('dragleave', () => {
            videoUploadArea.classList.remove('dragover');
        });
        
        videoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            videoUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleVideoFile(files[0]);
            }
        });
        
        videoFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleVideoFile(e.target.files[0]);
            }
        });
        
        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            selectedImageFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImageData = e.target.result;
                imagePreview.src = originalImageData;
                imagePreviewContainer.classList.add('show');
                imageSettings.classList.add('show');
                resizedPreviewContainer.classList.remove('show');
                
                const img = new Image();
                img.onload = () => {
                    originalWidth = img.width;
                    originalHeight = img.height;
                    aspectRatio = originalWidth / originalHeight;
                    
                    imageInfo.textContent = `æ–‡ä»¶å: ${file.name} | å°ºå¯¸: ${img.width} x ${img.height} | å¤§å°: ${formatFileSize(file.size)}`;
                    
                    widthInput.value = originalWidth;
                    heightInput.value = originalHeight;
                    widthInput.placeholder = originalWidth;
                    heightInput.placeholder = originalHeight;
                    
                    updateResizeInfo();
                };
                img.src = originalImageData;
            };
            reader.readAsDataURL(file);
            
            updateSubmitButton();
            hideError();
        }
        
        function handleVideoFile(file) {
            // Check if it's a video file by MIME type or file extension
            const fileName = file.name.toLowerCase();
            const isVideoByType = file.type.startsWith('video/');
            const isVideoByExtension = fileName.endsWith('.mp4') || fileName.endsWith('.webm') || 
                                        fileName.endsWith('.mov') || fileName.endsWith('.avi') || 
                                        fileName.endsWith('.ts') || fileName.endsWith('.mkv') ||
                                        fileName.endsWith('.m2ts') || fileName.endsWith('.mts');
            
            if (!isVideoByType && !isVideoByExtension) {
                showError('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒ MP4, WebM, MOV, TS æ ¼å¼ï¼‰');
                return;
            }
            
            const fileSizeMB = file.size / (1024 * 1024);
            if (fileSizeMB > 100) {
                showError('è§†é¢‘æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä¸Šä¼ å°äº 100MB çš„è§†é¢‘');
                return;
            }
            
            selectedVideoFile = file;
            
            const url = URL.createObjectURL(file);
            videoPreview.src = url;
            videoPreviewContainer.classList.add('show');
            videoSettings.classList.add('show');
            
            videoPreview.onloadedmetadata = () => {
                const duration = videoPreview.duration;
                const width = videoPreview.videoWidth;
                const height = videoPreview.videoHeight;
                
                videoInfo.textContent = `æ–‡ä»¶å: ${file.name} | å°ºå¯¸: ${width} x ${height} | æ—¶é•¿: ${duration.toFixed(2)}ç§’ | å¤§å°: ${formatFileSize(file.size)}`;
            };
            
            updateSubmitButton();
            hideError();
        }
        
        function updateSubmitButton() {
            if (currentMode === 'image') {
                submitBtn.disabled = !selectedImageFile;
            } else {
                submitBtn.disabled = !selectedVideoFile;
            }
        }
        
        // å®½åº¦è¾“å…¥å˜åŒ–æ—¶
        widthInput.addEventListener('input', () => {
            if (keepRatio.checked && widthInput.value) {
                const newWidth = parseInt(widthInput.value);
                if (!isNaN(newWidth) && newWidth > 0) {
                    heightInput.value = Math.round(newWidth / aspectRatio);
                }
            }
            updateResizeInfo();
            resizedPreviewContainer.classList.remove('show');
        });
        
        // é«˜åº¦è¾“å…¥å˜åŒ–æ—¶
        heightInput.addEventListener('input', () => {
            if (keepRatio.checked && heightInput.value) {
                const newHeight = parseInt(heightInput.value);
                if (!isNaN(newHeight) && newHeight > 0) {
                    widthInput.value = Math.round(newHeight * aspectRatio);
                }
            }
            updateResizeInfo();
            resizedPreviewContainer.classList.remove('show');
        });
        
        // ä¿æŒå®½é«˜æ¯”å¤é€‰æ¡†å˜åŒ–
        keepRatio.addEventListener('change', () => {
            if (keepRatio.checked && widthInput.value) {
                const newWidth = parseInt(widthInput.value);
                if (!isNaN(newWidth) && newWidth > 0) {
                    heightInput.value = Math.round(newWidth / aspectRatio);
                }
            }
            updateResizeInfo();
        });
        
        function updateResizeInfo() {
            const targetWidth = parseInt(widthInput.value) || originalWidth;
            const targetHeight = parseInt(heightInput.value) || originalHeight;
            
            if (targetWidth === originalWidth && targetHeight === originalHeight) {
                resizeInfo.textContent = 'å°†ä½¿ç”¨åŸå§‹å°ºå¯¸';
            } else {
                resizeInfo.textContent = `å°†è°ƒæ•´ä¸º ${targetWidth} x ${targetHeight} åƒç´ `;
            }
        }
        
        // é¢„è§ˆè°ƒæ•´åçš„å›¾ç‰‡
        previewResizeBtn.addEventListener('click', () => {
            if (!originalImageData) {
                showError('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }
            
            const targetWidth = parseInt(widthInput.value) || originalWidth;
            const targetHeight = parseInt(heightInput.value) || originalHeight;
            
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                
                const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.95);
                resizedImagePreview.src = resizedDataUrl;
                resizedInfoText.textContent = `è°ƒæ•´åå°ºå¯¸: ${targetWidth} x ${targetHeight} åƒç´ `;
                resizedPreviewContainer.classList.add('show');
            };
            img.src = originalImageData;
        });
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }
        
        // æäº¤åˆ†æ
        submitBtn.addEventListener('click', async () => {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                showError('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }
            
            submitBtn.disabled = true;
            loading.classList.add('show');
            resultSection.classList.remove('show');
            hideError();
            
            try {
                if (currentMode === 'image') {
                    await analyzeImage(prompt);
                } else {
                    await analyzeVideo(prompt);
                }
            } catch (error) {
                showError('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                loading.classList.remove('show');
            }
        });
        
        async function analyzeImage(prompt) {
            if (!selectedImageFile) {
                showError('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
                return;
            }
            
            loadingText.textContent = 'æ­£åœ¨åˆ†æå›¾ç‰‡ï¼Œè¯·ç¨å€™...';
            
            const formData = new FormData();
            formData.append('image', selectedImageFile);
            formData.append('prompt', prompt);
            formData.append('model_id', modelSelect.value);
            
            // æ·»åŠ  media_resolution å‚æ•°ï¼ˆæ‰€æœ‰æ¨¡å‹éƒ½æ”¯æŒï¼‰
            formData.append('media_resolution', mediaResolutionSelect.value);
            
            const targetWidth = parseInt(widthInput.value);
            const targetHeight = parseInt(heightInput.value);
            
            if (!isNaN(targetWidth) && targetWidth > 0) {
                formData.append('target_width', targetWidth);
            }
            if (!isNaN(targetHeight) && targetHeight > 0) {
                formData.append('target_height', targetHeight);
            }
            
            const response = await fetch('/api/analyze', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.error) {
                showError(data.error);
            } else {
                displayImageResult(data);
            }
        }
        
        async function analyzeVideo(prompt) {
            if (!selectedVideoFile) {
                showError('è¯·å…ˆé€‰æ‹©è§†é¢‘');
                return;
            }
            
            const videoMode = modeDirectRadio.checked ? 'direct' : 'frames';
            
            if (videoMode === 'direct') {
                loadingText.textContent = 'æ­£åœ¨å‘é€è§†é¢‘ç»™ Gemini åˆ†æï¼Œè¯·ç¨å€™...';
            } else {
                loadingText.textContent = 'æ­£åœ¨æå–è§†é¢‘å¸§å¹¶åˆ†æï¼Œè¯·ç¨å€™...';
            }
            
            const formData = new FormData();
            formData.append('video', selectedVideoFile);
            formData.append('prompt', prompt);
            formData.append('mode', videoMode);
            formData.append('model_id', modelSelect.value);
            
            // æ·»åŠ è§†é¢‘é«˜çº§è®¾ç½®å‚æ•°ï¼ˆç›´æ¥å‘é€è§†é¢‘æ¨¡å¼ï¼‰
            if (videoMode === 'direct') {
                formData.append('media_resolution', mediaResolutionSelect.value);
                
                // æ·»åŠ è§†é¢‘ FPS
                const videoFps = parseFloat(videoFpsInput.value);
                if (!isNaN(videoFps) && videoFps > 0 && videoFps <= 24) {
                    formData.append('video_fps', videoFps);
                }
                
                // æ·»åŠ èµ·å§‹æ—¶é—´
                const startOffset = startOffsetInput.value.trim();
                if (startOffset) {
                    // ç¡®ä¿æ ¼å¼æ­£ç¡®ï¼ˆæ·»åŠ  's' åç¼€å¦‚æœæ²¡æœ‰ï¼‰
                    const startValue = startOffset.endsWith('s') ? startOffset : startOffset + 's';
                    formData.append('start_offset', startValue);
                }
                
                // æ·»åŠ ç»“æŸæ—¶é—´
                const endOffset = endOffsetInput.value.trim();
                if (endOffset) {
                    const endValue = endOffset.endsWith('s') ? endOffset : endOffset + 's';
                    formData.append('end_offset', endValue);
                }
            }
            
            if (videoMode === 'frames') {
                formData.append('fps', fpsInput.value || '1');
                formData.append('max_frames', maxFramesInput.value || '30');
                
                // æ·»åŠ å¸§å°ºå¯¸å‚æ•°
                if (frameWidthInput.value) {
                    formData.append('frame_width', frameWidthInput.value);
                }
                if (frameHeightInput.value) {
                    formData.append('frame_height', frameHeightInput.value);
                }
            }
            
            const response = await fetch('/api/analyze_video', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.error) {
                showError(data.error);
            } else {
                displayVideoResult(data);
            }
        }
        
        function displayTokenDetails(tokenDetails) {
            if (!tokenDetails) {
                document.getElementById('tokenDetailsSection').style.display = 'none';
                return;
            }
            
            // Input tokens è¯¦æƒ…
            const promptDetails = tokenDetails.prompt_tokens_details || {};
            document.getElementById('inputTextTokens').textContent = promptDetails.text_tokens || 0;
            document.getElementById('inputImageTokens').textContent = promptDetails.image_tokens || 0;
            document.getElementById('inputVideoTokens').textContent = promptDetails.video_tokens || 0;
            document.getElementById('inputAudioTokens').textContent = promptDetails.audio_tokens || 0;
            document.getElementById('inputCachedTokens').textContent = promptDetails.cached_tokens || 0;
            
            // Output tokens è¯¦æƒ…
            const candidatesDetails = tokenDetails.candidates_tokens_details || {};
            document.getElementById('outputTextTokens').textContent = candidatesDetails.text_tokens || 0;
            document.getElementById('outputImageTokens').textContent = candidatesDetails.image_tokens || 0;
            document.getElementById('outputVideoTokens').textContent = candidatesDetails.video_tokens || 0;
            document.getElementById('outputAudioTokens').textContent = candidatesDetails.audio_tokens || 0;
            
            // ç‰¹æ®Š tokens
            document.getElementById('thinkingTokens').textContent = candidatesDetails.thinking_tokens || 0;
            document.getElementById('toolUseTokens').textContent = candidatesDetails.tool_use_tokens || 0;
            document.getElementById('cachedContentTokens').textContent = tokenDetails.cached_content_token_count || 0;
            
            document.getElementById('tokenDetailsSection').style.display = 'block';
        }
        
        function displayImageResult(data) {
            document.getElementById('inputTokens').textContent = data.input_tokens || '-';
            document.getElementById('outputTokens').textContent = data.output_tokens || '-';
            document.getElementById('totalTokens').textContent = data.total_tokens || '-';
            document.getElementById('responseContent').textContent = data.response || 'æ— å“åº”å†…å®¹';
            
            // æ˜¾ç¤ºè¯¦ç»† token ä¿¡æ¯
            displayTokenDetails(data.token_details);
            
            // æ˜¾ç¤ºå›¾ç‰‡å°ºå¯¸ä¿¡æ¯
            document.getElementById('imageSizeInfo').style.display = 'block';
            document.getElementById('videoResultInfo').style.display = 'none';
            
            if (data.image_info) {
                document.getElementById('originalSizeText').textContent = `åŸå§‹å°ºå¯¸: ${data.image_info.original_size}`;
                document.getElementById('processedSizeText').textContent = `å¤„ç†åå°ºå¯¸: ${data.image_info.processed_size}`;
                document.getElementById('resizedText').textContent = `æ˜¯å¦è°ƒæ•´: ${data.image_info.resized ? 'æ˜¯' : 'å¦'}`;
            }
            
            // æ˜¾ç¤ºå¤„ç†åçš„å›¾ç‰‡
            if (data.processed_image_base64) {
                document.getElementById('processedImageResult').src = 'data:image/jpeg;base64,' + data.processed_image_base64;
                document.getElementById('processedImageSection').style.display = 'block';
            } else {
                document.getElementById('processedImageSection').style.display = 'none';
            }
            
            document.getElementById('framesPreviewSection').style.display = 'none';
            resultSection.classList.add('show');
        }
        
        function displayVideoResult(data) {
            document.getElementById('inputTokens').textContent = data.input_tokens || '-';
            document.getElementById('outputTokens').textContent = data.output_tokens || '-';
            document.getElementById('totalTokens').textContent = data.total_tokens || '-';
            document.getElementById('responseContent').textContent = data.response || 'æ— å“åº”å†…å®¹';
            
            // æ˜¾ç¤ºè¯¦ç»† token ä¿¡æ¯
            displayTokenDetails(data.token_details);
            
            // æ˜¾ç¤ºè§†é¢‘ä¿¡æ¯
            document.getElementById('imageSizeInfo').style.display = 'none';
            document.getElementById('videoResultInfo').style.display = 'block';
            
            if (data.video_info) {
                document.getElementById('videoDimensionsText').textContent = `è§†é¢‘å°ºå¯¸: ${data.video_info.width} x ${data.video_info.height}`;
                document.getElementById('videoDurationText').textContent = `è§†é¢‘æ—¶é•¿: ${data.video_info.duration} ç§’`;
                document.getElementById('videoOriginalFpsText').textContent = `åŸå§‹å¸§ç‡: ${data.video_info.original_fps} fps`;
                
                // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒä¿¡æ¯
                if (data.video_info.mode === 'direct') {
                    let directInfo = `å¤„ç†æ¨¡å¼: ç›´æ¥å‘é€è§†é¢‘`;
                    if (data.video_info.video_fps) {
                        directInfo += ` | é‡‡æ ·å¸§ç‡: ${data.video_info.video_fps} fps`;
                    }
                    if (data.video_info.media_resolution) {
                        directInfo += ` | åˆ†è¾¨ç‡: ${data.video_info.media_resolution}`;
                    }
                    document.getElementById('videoExtractFpsText').textContent = directInfo;
                    
                    let clipInfo = '';
                    if (data.video_info.start_offset || data.video_info.end_offset) {
                        clipInfo = `æ—¶é—´è£å‰ª: ${data.video_info.start_offset || '0s'} - ${data.video_info.end_offset || 'ç»“æŸ'}`;
                    }
                    document.getElementById('framesExtractedText').textContent = clipInfo;
                } else {
                    let extractInfo = `æå–å¸§ç‡: ${data.video_info.extract_fps} fps`;
                    if (data.video_info.frame_size) {
                        extractInfo += ` | å¸§å°ºå¯¸: ${data.video_info.frame_size}`;
                    }
                    document.getElementById('videoExtractFpsText').textContent = extractInfo;
                    document.getElementById('framesExtractedText').textContent = `æå–å¸§æ•°: ${data.video_info.frames_extracted} å¸§`;
                }
            }
            
            // æ˜¾ç¤ºå¸§é¢„è§ˆ
            document.getElementById('processedImageSection').style.display = 'none';
            
            if (data.frames_preview && data.frames_preview.length > 0) {
                const framesPreview = document.getElementById('framesPreview');
                framesPreview.innerHTML = '';
                data.frames_preview.forEach((frameBase64, index) => {
                    const img = document.createElement('img');
                    img.src = 'data:image/jpeg;base64,' + frameBase64;
                    img.alt = `å¸§ ${index + 1}`;
                    img.title = `å¸§ ${index + 1}`;
                    framesPreview.appendChild(img);
                });
                document.getElementById('framesPreviewSection').style.display = 'block';
            } else {
                document.getElementById('framesPreviewSection').style.display = 'none';
            }
            
            resultSection.classList.add('show');
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
        }
        
        function hideError() {
            errorMessage.classList.remove('show');
        }
        
        // LangChain æŒ‰é’®
        const submitLangchainBtn = document.getElementById('submitLangchainBtn');
        
        // æ›´æ–° LangChain æŒ‰é’®çŠ¶æ€
        function updateLangchainButton() {
            if (currentMode === 'image') {
                submitLangchainBtn.disabled = !selectedImageFile;
                submitLangchainBtn.style.display = 'block';
            } else {
                submitLangchainBtn.style.display = 'none';
            }
        }
        
        // ä¿®æ”¹ updateSubmitButton å‡½æ•°
        const originalUpdateSubmitButton = updateSubmitButton;
        updateSubmitButton = function() {
            if (currentMode === 'image') {
                submitBtn.disabled = !selectedImageFile;
                submitLangchainBtn.disabled = !selectedImageFile;
                submitLangchainBtn.style.display = 'block';
            } else {
                submitBtn.disabled = !selectedVideoFile;
                submitLangchainBtn.style.display = 'none';
            }
        };
        
        // LangChain åˆ†æ
        submitLangchainBtn.addEventListener('click', async () => {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                showError('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }
            
            if (!selectedImageFile) {
                showError('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
                return;
            }
            
            submitLangchainBtn.disabled = true;
            submitBtn.disabled = true;
            loading.classList.add('show');
            resultSection.classList.remove('show');
            hideError();
            
            loadingText.textContent = 'æ­£åœ¨ä½¿ç”¨ LangChain ChatVertexAI åˆ†æå›¾ç‰‡ (media_resolution=medium)...';
            
            try {
                const formData = new FormData();
                formData.append('image', selectedImageFile);
                formData.append('prompt', prompt);
                formData.append('model_id', modelSelect.value);
                formData.append('media_resolution', 'medium');  // å›ºå®šä½¿ç”¨ medium
                
                const response = await fetch('/api/analyze_langchain', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                } else {
                    displayLangchainResult(data);
                }
            } catch (error) {
                showError('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                submitLangchainBtn.disabled = false;
                submitBtn.disabled = false;
                loading.classList.remove('show');
            }
        });
        
        function displayLangchainResult(data) {
            document.getElementById('inputTokens').textContent = data.input_tokens || '-';
            document.getElementById('outputTokens').textContent = data.output_tokens || '-';
            document.getElementById('totalTokens').textContent = data.total_tokens || '-';
            document.getElementById('responseContent').textContent = data.response || 'æ— å“åº”å†…å®¹';
            
            // éšè—è¯¦ç»† token ä¿¡æ¯ï¼ˆLangChain è¿”å›æ ¼å¼ä¸åŒï¼‰
            document.getElementById('tokenDetailsSection').style.display = 'none';
            
            // æ˜¾ç¤º LangChain ä¿¡æ¯
            document.getElementById('imageSizeInfo').style.display = 'block';
            document.getElementById('videoResultInfo').style.display = 'none';
            
            document.getElementById('originalSizeText').textContent = `æ¡†æ¶: ${data.framework || 'langchain'}`;
            document.getElementById('processedSizeText').textContent = `Media Resolution: ${data.media_resolution || 'medium'}`;
            document.getElementById('resizedText').textContent = `Generation Config: ${JSON.stringify(data.generation_config || {})}`;
            
            document.getElementById('processedImageSection').style.display = 'none';
            document.getElementById('framesPreviewSection').style.display = 'none';
            resultSection.classList.add('show');
        }
        
        // åˆå§‹åŒ– LangChain æŒ‰é’®çŠ¶æ€
        updateSubmitButton();
        
        // ==================== äººè„¸è¯†åˆ«åŠŸèƒ½ ====================
        
        // äººè„¸è¯†åˆ«ç›¸å…³å˜é‡
        const faceUploadArea = document.getElementById('faceUploadArea');
        const faceImageInput = document.getElementById('faceImageInput');
        const facePreviewContainer = document.getElementById('facePreviewContainer');
        const facePreview = document.getElementById('facePreview');
        const faceNameInput = document.getElementById('faceNameInput');
        const registerFaceBtn = document.getElementById('registerFaceBtn');
        const refreshFacesBtn = document.getElementById('refreshFacesBtn');
        const facesList = document.getElementById('facesList');
        
        const faceVideoUploadArea = document.getElementById('faceVideoUploadArea');
        const faceVideoInput = document.getElementById('faceVideoInput');
        const faceVideoPreviewContainer = document.getElementById('faceVideoPreviewContainer');
        const faceVideoPreview = document.getElementById('faceVideoPreview');
        const faceVideoInfo = document.getElementById('faceVideoInfo');
        const faceRecFpsInput = document.getElementById('faceRecFpsInput');
        const faceRecMaxFramesInput = document.getElementById('faceRecMaxFramesInput');
        const useGeminiCheckbox = document.getElementById('useGeminiCheckbox');
        const startFaceRecBtn = document.getElementById('startFaceRecBtn');
        
        let selectedFaceImage = null;
        let selectedFaceVideo = null;
        
        // æˆ·ä¸»ç…§ç‰‡ä¸Šä¼ 
        faceUploadArea.addEventListener('click', () => faceImageInput.click());
        
        faceUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            faceUploadArea.classList.add('dragover');
        });
        
        faceUploadArea.addEventListener('dragleave', () => {
            faceUploadArea.classList.remove('dragover');
        });
        
        faceUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            faceUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFaceImage(e.dataTransfer.files[0]);
            }
        });
        
        faceImageInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFaceImage(e.target.files[0]);
            }
        });
        
        function handleFaceImage(file) {
            if (!file.type.startsWith('image/')) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            selectedFaceImage = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                facePreview.src = e.target.result;
                facePreviewContainer.style.display = 'block';
                updateRegisterButton();
            };
            reader.readAsDataURL(file);
        }
        
        // æˆ·ä¸»å§“åè¾“å…¥
        faceNameInput.addEventListener('input', updateRegisterButton);
        
        function updateRegisterButton() {
            registerFaceBtn.disabled = !selectedFaceImage || !faceNameInput.value.trim();
        }
        
        // æ³¨å†Œæˆ·ä¸»
        registerFaceBtn.addEventListener('click', async () => {
            const name = faceNameInput.value.trim();
            if (!selectedFaceImage || !name) {
                showError('è¯·ä¸Šä¼ ç…§ç‰‡å¹¶è¾“å…¥å§“å');
                return;
            }
            
            registerFaceBtn.disabled = true;
            registerFaceBtn.textContent = 'æ³¨å†Œä¸­...';
            
            try {
                const formData = new FormData();
                formData.append('image', selectedFaceImage);
                formData.append('name', name);
                
                const response = await fetch('/api/face/register', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    // é‡ç½®è¡¨å•
                    selectedFaceImage = null;
                    faceImageInput.value = '';
                    facePreviewContainer.style.display = 'none';
                    faceNameInput.value = '';
                    // åˆ·æ–°åˆ—è¡¨
                    loadFacesList();
                } else {
                    showError(data.message || data.error);
                }
            } catch (error) {
                showError('æ³¨å†Œå¤±è´¥: ' + error.message);
            } finally {
                registerFaceBtn.disabled = false;
                registerFaceBtn.textContent = 'æ³¨å†Œæˆ·ä¸»';
                updateRegisterButton();
            }
        });
        
        // åˆ·æ–°æˆ·ä¸»åˆ—è¡¨
        refreshFacesBtn.addEventListener('click', loadFacesList);
        
        async function loadFacesList() {
            try {
                const response = await fetch('/api/face/list');
                const data = await response.json();
                
                if (data.success) {
                    if (data.faces.length === 0) {
                        facesList.innerHTML = '<p class="no-faces-text">æš‚æ— å·²æ³¨å†Œæˆ·ä¸»</p>';
                    } else {
                        facesList.innerHTML = data.faces.map(face => `
                            <div class="face-item">
                                <span class="face-name">ğŸ‘¤ ${face.name}</span>
                                <span class="face-count">(${face.photo_count}å¼ ç…§ç‰‡)</span>
                                <button class="delete-face-btn" onclick="deleteFace('${face.name}')">åˆ é™¤</button>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æˆ·ä¸»åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // åˆ é™¤æˆ·ä¸»
        async function deleteFace(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æˆ·ä¸» "${name}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/face/delete/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadFacesList();
                } else {
                    showError(data.message || data.error);
                }
            } catch (error) {
                showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // è§†é¢‘ä¸Šä¼ ï¼ˆäººè„¸è¯†åˆ«ï¼‰
        faceVideoUploadArea.addEventListener('click', () => faceVideoInput.click());
        
        faceVideoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            faceVideoUploadArea.classList.add('dragover');
        });
        
        faceVideoUploadArea.addEventListener('dragleave', () => {
            faceVideoUploadArea.classList.remove('dragover');
        });
        
        faceVideoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            faceVideoUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFaceVideo(e.dataTransfer.files[0]);
            }
        });
        
        faceVideoInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFaceVideo(e.target.files[0]);
            }
        });
        
        function handleFaceVideo(file) {
            const fileName = file.name.toLowerCase();
            const isVideo = file.type.startsWith('video/') || 
                           fileName.endsWith('.mp4') || fileName.endsWith('.webm') || 
                           fileName.endsWith('.mov') || fileName.endsWith('.ts');
            
            if (!isVideo) {
                showError('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶');
                return;
            }
            
            selectedFaceVideo = file;
            
            const url = URL.createObjectURL(file);
            faceVideoPreview.src = url;
            faceVideoPreviewContainer.style.display = 'block';
            
            faceVideoPreview.onloadedmetadata = () => {
                faceVideoInfo.textContent = `${file.name} | ${(file.size / 1024 / 1024).toFixed(2)} MB | ${faceVideoPreview.duration.toFixed(1)}ç§’`;
            };
            
            startFaceRecBtn.disabled = false;
        }
        
        // å¼€å§‹äººè„¸è¯†åˆ«
        startFaceRecBtn.addEventListener('click', async () => {
            if (!selectedFaceVideo) {
                showError('è¯·å…ˆé€‰æ‹©è§†é¢‘');
                return;
            }
            
            startFaceRecBtn.disabled = true;
            startFaceRecBtn.textContent = 'è¯†åˆ«ä¸­...';
            loading.classList.add('show');
            loadingText.textContent = 'æ­£åœ¨è¿›è¡Œäººè„¸è¯†åˆ«ï¼Œè¯·ç¨å€™...';
            document.getElementById('faceResultSection').style.display = 'none';
            hideError();
            
            try {
                const formData = new FormData();
                formData.append('video', selectedFaceVideo);
                formData.append('fps', faceRecFpsInput.value || '1');
                formData.append('max_frames', faceRecMaxFramesInput.value || '30');
                formData.append('use_gemini', useGeminiCheckbox.checked ? 'true' : 'false');
                formData.append('prompt', 'è¯·æè¿°è§†é¢‘ä¸­äººç‰©çš„è¡Œä¸ºå’Œåœºæ™¯');
                formData.append('model_id', modelSelect.value);
                
                const response = await fetch('/api/face/recognize_video', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayFaceRecognitionResult(data);
                } else {
                    showError(data.error || 'è¯†åˆ«å¤±è´¥');
                }
            } catch (error) {
                showError('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                startFaceRecBtn.disabled = false;
                startFaceRecBtn.textContent = 'ğŸ” å¼€å§‹äººè„¸è¯†åˆ«';
                loading.classList.remove('show');
            }
        });
        
        function displayFaceRecognitionResult(data) {
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('faceResultSection').style.display = 'block';
            
            // æ˜¾ç¤ºæ‘˜è¦
            document.getElementById('faceSummaryText').textContent = data.summary?.summary || 'æ— è¯†åˆ«ç»“æœ';
            
            // æ˜¾ç¤ºç›¸ä¼¼åº¦ç»Ÿè®¡
            const statsBox = document.getElementById('similarityStatsBox');
            const statsGrid = document.getElementById('similarityStatsGrid');
            const similarityStats = data.summary?.similarity_stats;
            
            if (similarityStats && Object.keys(similarityStats).length > 0) {
                let statsHtml = '';
                for (const [name, stats] of Object.entries(similarityStats)) {
                    const maxPercent = (stats.max * 100).toFixed(1);
                    const avgPercent = (stats.avg * 100).toFixed(1);
                    const minPercent = (stats.min * 100).toFixed(1);
                    
                    // æ ¹æ®æœ€é«˜ç›¸ä¼¼åº¦å†³å®šé¢œè‰²
                    let colorClass = 'low';
                    let barColor = '#dc3545';
                    if (stats.max >= 0.7) {
                        colorClass = 'high';
                        barColor = '#28a745';
                    } else if (stats.max >= 0.5) {
                        colorClass = 'medium';
                        barColor = '#ffc107';
                    }
                    
                    statsHtml += `
                        <div class="similarity-stat-card">
                            <div class="person-name">ğŸ‘¤ ${name}</div>
                            <div class="stat-row">
                                <span class="stat-label">å‡ºç°æ¬¡æ•°</span>
                                <span class="stat-value">${stats.count} æ¬¡</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">æœ€é«˜ç›¸ä¼¼åº¦</span>
                                <span class="stat-value ${colorClass}">${maxPercent}%</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">å¹³å‡ç›¸ä¼¼åº¦</span>
                                <span class="stat-value">${avgPercent}%</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">æœ€ä½ç›¸ä¼¼åº¦</span>
                                <span class="stat-value">${minPercent}%</span>
                            </div>
                            <div class="similarity-bar">
                                <div class="similarity-bar-fill" style="width: ${maxPercent}%; background: ${barColor};"></div>
                            </div>
                        </div>
                    `;
                }
                statsGrid.innerHTML = statsHtml;
                statsBox.style.display = 'block';
            } else {
                statsBox.style.display = 'none';
            }
            
            // æ˜¾ç¤ºæ ‡æ³¨å¸§å›¾ç‰‡
            const framesBox = document.getElementById('annotatedFramesBox');
            const framesGrid = document.getElementById('annotatedFramesGrid');
            const annotatedFrames = data.annotated_frames;
            
            if (annotatedFrames && annotatedFrames.length > 0) {
                let framesHtml = '';
                annotatedFrames.forEach((frame, index) => {
                    framesHtml += `
                        <div class="annotated-frame-item" onclick="showImageModal(${index})">
                            <img src="data:image/jpeg;base64,${frame.image_base64}" alt="å¸§${frame.frame}">
                            <div class="annotated-frame-info">
                                <div class="frame-time">å¸§${frame.frame} - ${frame.time}ç§’</div>
                                <div class="frame-stats">
                                    ${frame.recognized_count > 0 ? `<span class="stat-recognized">âœ“ æˆ·ä¸»${frame.recognized_count}</span>` : ''}
                                    ${frame.stranger_count > 0 ? `<span class="stat-stranger">âš  é™Œç”Ÿäºº${frame.stranger_count}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                framesGrid.innerHTML = framesHtml;
                framesBox.style.display = 'block';
                
                // ä¿å­˜æ ‡æ³¨å¸§æ•°æ®ä¾›æ¨¡æ€æ¡†ä½¿ç”¨
                window.annotatedFramesData = annotatedFrames;
            } else {
                framesBox.style.display = 'none';
            }
            
            // æ˜¾ç¤ºè¯¦ç»†è®°å½•
            const detailsList = document.getElementById('faceDetailsList');
            if (data.face_results && data.face_results.length > 0) {
                let detailsHtml = '';
                data.face_results.forEach(frame => {
                    if (frame.faces && frame.faces.length > 0) {
                        frame.faces.forEach(face => {
                            const isRecognized = face.name !== 'æœªçŸ¥' && face.similarity >= 0.7;
                            detailsHtml += `
                                <div class="face-detail-item">
                                    <span class="time">å¸§${frame.frame} (${frame.time}s)</span>
                                    <span class="name ${isRecognized ? 'recognized' : 'unknown'}">${isRecognized ? face.name : 'é™Œç”Ÿäºº'}</span>
                                    <span class="similarity">ç›¸ä¼¼åº¦: ${(face.similarity * 100).toFixed(1)}%</span>
                                </div>
                            `;
                        });
                    }
                });
                detailsList.innerHTML = detailsHtml || '<p>æœªæ£€æµ‹åˆ°äººè„¸</p>';
            } else {
                detailsList.innerHTML = '<p>æœªæ£€æµ‹åˆ°äººè„¸</p>';
            }
            
            // æ˜¾ç¤º Gemini åˆ†æï¼ˆå¦‚æœæœ‰ï¼‰
            const geminiBox = document.getElementById('geminiAnalysisBox');
            if (data.gemini_analysis) {
                document.getElementById('geminiAnalysisContent').textContent = data.gemini_analysis;
                geminiBox.style.display = 'block';
            } else {
                geminiBox.style.display = 'none';
            }
            
            // æ˜¾ç¤ºå¤„ç†æ—¶é—´
            if (data.processing_time) {
                document.getElementById('faceProcessingTimeText').textContent = 
                    `å¤„ç†æ—¶é—´: äººè„¸è¯†åˆ« ${data.processing_time.face_recognition}ç§’` +
                    (data.processing_time.gemini_analysis > 0 ? ` | Geminiåˆ†æ ${data.processing_time.gemini_analysis}ç§’` : '') +
                    ` | æ€»è®¡ ${data.processing_time.total}ç§’`;
            }
        }
        
        // å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†åŠŸèƒ½
        function showImageModal(index) {
            const frame = window.annotatedFramesData[index];
            if (!frame) return;
            
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('imageModalImg');
            const modalInfo = document.getElementById('imageModalInfo');
            
            modalImg.src = 'data:image/jpeg;base64,' + frame.image_base64;
            
            let infoHtml = `å¸§${frame.frame} - æ—¶é—´: ${frame.time}ç§’ | `;
            if (frame.recognized_count > 0) {
                infoHtml += `<span class="info-recognized">è¯†åˆ«åˆ°æˆ·ä¸»: ${frame.recognized_count}äºº</span> `;
            }
            if (frame.stranger_count > 0) {
                infoHtml += `<span class="info-stranger">âš  å‘ç°é™Œç”Ÿäºº: ${frame.stranger_count}äºº</span>`;
            }
            modalInfo.innerHTML = infoHtml;
            
            modal.classList.add('show');
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        document.getElementById('imageModalClose').addEventListener('click', () => {
            document.getElementById('imageModal').classList.remove('show');
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('imageModal')) {
                document.getElementById('imageModal').classList.remove('show');
            }
        });
        
        // ESC é”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('imageModal').classList.remove('show');
            }
        });
        
        // ==================== è§†é¢‘æ ‡æ³¨æ¨¡å¼ ====================
        
        const labelMode = document.getElementById('labelMode');
        const labelPersonImageInput = document.getElementById('labelPersonImageInput');
        const labelPersonUploadArea = document.getElementById('labelPersonUploadArea');
        const labelPersonPreview = document.getElementById('labelPersonPreview');
        const labelPersonNameInput = document.getElementById('labelPersonNameInput');
        const addLabelPersonBtn = document.getElementById('addLabelPersonBtn');
        const labelPersonsList = document.getElementById('labelPersonsList');
        const labelPersonCount = document.getElementById('labelPersonCount');
        const labelVideoInput = document.getElementById('labelVideoInput');
        const labelVideoUploadArea = document.getElementById('labelVideoUploadArea');
        const labelVideoPreviewContainer = document.getElementById('labelVideoPreviewContainer');
        const labelVideoPreview = document.getElementById('labelVideoPreview');
        const labelVideoInfo = document.getElementById('labelVideoInfo');
        const startLabelBtn = document.getElementById('startLabelBtn');
        const labelProgressSection = document.getElementById('labelProgressSection');
        const labelProgressBar = document.getElementById('labelProgressBar');
        const labelProgressText = document.getElementById('labelProgressText');
        const labelResultSection = document.getElementById('labelResultSection');
        const labelStats = document.getElementById('labelStats');
        const labelDownloadBtn = document.getElementById('labelDownloadBtn');
        const labelProcessingTime = document.getElementById('labelProcessingTime');
        
        let labelSessionId = null;
        let labelPersons = []; // å­˜å‚¨ {name, imageData} å¯¹è±¡
        let labelSelectedImageData = null;
        let labelSelectedVideo = null;
        
        // åˆ›å»ºæ ‡æ³¨ä¼šè¯
        async function createLabelSession() {
            try {
                const response = await fetch('/api/label/create_session', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    labelSessionId = data.session_id;
                    console.log('æ ‡æ³¨ä¼šè¯å·²åˆ›å»º:', labelSessionId);
                }
            } catch (error) {
                console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
            }
        }
        
        // ç›‘å¬æ¨¡å¼åˆ‡æ¢ï¼Œå½“åˆ‡æ¢åˆ°è§†é¢‘æ ‡æ³¨æ¨¡å¼æ—¶åˆå§‹åŒ–ä¼šè¯
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const mode = this.dataset.mode;
                if (mode === 'label' && !labelSessionId) {
                    createLabelSession();
                    labelPersons = [];
                    updateLabelPersonsList();
                }
            });
        });
        
        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        labelPersonUploadArea.addEventListener('click', () => labelPersonImageInput.click());
        
        // é€‰æ‹©ç…§ç‰‡
        labelPersonImageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    labelSelectedImageData = e.target.result;
                    labelPersonPreview.src = labelSelectedImageData;
                    labelPersonPreview.style.display = 'block';
                    updateAddPersonBtnState();
                };
                reader.readAsDataURL(file);
            }
        });
        
        // åå­—è¾“å…¥
        labelPersonNameInput.addEventListener('input', updateAddPersonBtnState);
        
        function updateAddPersonBtnState() {
            const hasImage = labelSelectedImageData !== null;
            const hasName = labelPersonNameInput.value.trim().length > 0;
            addLabelPersonBtn.disabled = !(hasImage && hasName);
        }
        
        // æ·»åŠ äººç‰©
        addLabelPersonBtn.addEventListener('click', async function() {
            if (!labelSessionId) {
                await createLabelSession();
            }
            
            const name = labelPersonNameInput.value.trim();
            if (!name || !labelSelectedImageData) return;
            
            // æ£€æŸ¥åå­—æ ¼å¼
            if (!/^[a-zA-Z0-9_]+$/.test(name)) {
                alert('åå­—åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
                return;
            }
            
            // æ£€æŸ¥é‡å
            if (labelPersons.some(p => p.name === name)) {
                alert('è¯¥åå­—å·²å­˜åœ¨');
                return;
            }
            
            addLabelPersonBtn.disabled = true;
            addLabelPersonBtn.textContent = 'æ·»åŠ ä¸­...';
            
            try {
                const formData = new FormData();
                formData.append('session_id', labelSessionId);
                formData.append('name', name);
                
                // å°† base64 è½¬æ¢ä¸º Blob
                const base64Data = labelSelectedImageData.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteArray = new Uint8Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteArray[i] = byteCharacters.charCodeAt(i);
                }
                const blob = new Blob([byteArray], { type: 'image/jpeg' });
                formData.append('image', blob, 'photo.jpg');
                
                const response = await fetch('/api/label/add_person', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    labelPersons.push({name: name, imageData: labelSelectedImageData});
                    updateLabelPersonsList();
                    
                    // é‡ç½®è¾“å…¥
                    labelPersonNameInput.value = '';
                    labelSelectedImageData = null;
                    labelPersonPreview.style.display = 'none';
                    labelPersonImageInput.value = '';
                } else {
                    alert(data.error || 'æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            } finally {
                addLabelPersonBtn.disabled = false;
                addLabelPersonBtn.textContent = 'æ·»åŠ ';
                updateAddPersonBtnState();
                updateStartLabelBtnState();
            }
        });
        
        // æ›´æ–°äººç‰©åˆ—è¡¨æ˜¾ç¤º
        function updateLabelPersonsList() {
            labelPersonCount.textContent = labelPersons.length;
            
            if (labelPersons.length === 0) {
                labelPersonsList.innerHTML = '<p class="no-persons-text">æš‚æœªæ·»åŠ äººç‰©</p>';
            } else {
                labelPersonsList.innerHTML = labelPersons.map(person => `
                    <div class="person-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 8px; margin-bottom: 6px;">
                        <img src="${person.imageData}" alt="${person.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid #4CAF50;">
                        <span class="person-name" style="flex: 1; font-weight: 500;">${person.name}</span>
                        <button class="remove-person-btn" data-name="${person.name}" style="background: #ff5252; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">Ã—</button>
                    </div>
                `).join('');
                
                // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
                labelPersonsList.querySelectorAll('.remove-person-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        removeLabelPerson(this.dataset.name);
                    });
                });
            }
        }
        
        // ç§»é™¤äººç‰©
        async function removeLabelPerson(name) {
            try {
                const formData = new FormData();
                formData.append('session_id', labelSessionId);
                formData.append('name', name);
                
                await fetch('/api/label/remove_person', {
                    method: 'POST',
                    body: formData
                });
                
                labelPersons = labelPersons.filter(p => p.name !== name);
                updateLabelPersonsList();
                updateStartLabelBtnState();
            } catch (error) {
                console.error('ç§»é™¤å¤±è´¥:', error);
            }
        }
        
        // è§†é¢‘ä¸Šä¼ åŒºåŸŸ
        labelVideoUploadArea.addEventListener('click', () => labelVideoInput.click());
        
        labelVideoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            labelVideoUploadArea.classList.add('drag-over');
        });
        
        labelVideoUploadArea.addEventListener('dragleave', () => {
            labelVideoUploadArea.classList.remove('drag-over');
        });
        
        labelVideoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            labelVideoUploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                handleLabelVideoSelect(file);
            }
        });
        
        labelVideoInput.addEventListener('change', function() {
            if (this.files[0]) {
                handleLabelVideoSelect(this.files[0]);
            }
        });
        
        function handleLabelVideoSelect(file) {
            labelSelectedVideo = file;
            labelVideoPreview.src = URL.createObjectURL(file);
            labelVideoPreviewContainer.style.display = 'block';
            labelVideoInfo.textContent = `æ–‡ä»¶: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            labelVideoUploadArea.style.display = 'none';
            updateStartLabelBtnState();
        }
        
        // æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
        function updateStartLabelBtnState() {
            startLabelBtn.disabled = !(labelPersons.length > 0 && labelSelectedVideo);
        }
        
        // å¼€å§‹æ ‡æ³¨
        startLabelBtn.addEventListener('click', async function() {
            if (!labelSessionId || labelPersons.length === 0 || !labelSelectedVideo) {
                return;
            }
            
            startLabelBtn.disabled = true;
            startLabelBtn.textContent = 'å¤„ç†ä¸­...';
            labelProgressSection.style.display = 'block';
            labelResultSection.style.display = 'none';
            labelProgressBar.style.width = '0%';
            labelProgressText.textContent = 'æ­£åœ¨ä¸Šä¼ è§†é¢‘...';
            
            try {
                const formData = new FormData();
                formData.append('session_id', labelSessionId);
                formData.append('video', labelSelectedVideo);
                formData.append('threshold', document.getElementById('labelThresholdInput').value / 100);
                formData.append('show_unknown', document.getElementById('labelShowUnknownCheckbox').checked);
                
                labelProgressBar.style.width = '20%';
                labelProgressText.textContent = 'è§†é¢‘å·²ä¸Šä¼ ï¼Œæ­£åœ¨åˆ†æäººè„¸...';
                
                const response = await fetch('/api/label/process_video', {
                    method: 'POST',
                    body: formData
                });
                
                labelProgressBar.style.width = '80%';
                labelProgressText.textContent = 'æ­£åœ¨ç”Ÿæˆæ ‡æ³¨è§†é¢‘...';
                
                const data = await response.json();
                
                if (data.success) {
                    labelProgressBar.style.width = '100%';
                    labelProgressText.textContent = 'æ ‡æ³¨å®Œæˆ!';
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayLabelResult(data);
                } else {
                    labelProgressText.textContent = 'å¤„ç†å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
                }
                
            } catch (error) {
                labelProgressText.textContent = 'å¤„ç†å¤±è´¥: ' + error.message;
            } finally {
                startLabelBtn.disabled = false;
                startLabelBtn.textContent = 'ğŸš€ å¼€å§‹æ ‡æ³¨è§†é¢‘';
            }
        });
        
        // æ˜¾ç¤ºæ ‡æ³¨ç»“æœ
        function displayLabelResult(data) {
            labelResultSection.style.display = 'block';
            
            const stats = data.stats;
            let statsHtml = `
                <p>ğŸ“Š <strong>å¤„ç†å¸§æ•°:</strong> ${stats.processed_frames} / ${stats.total_frames}</p>
                <p>ğŸ‘¤ <strong>æ£€æµ‹äººè„¸æ•°:</strong> ${stats.faces_detected}</p>
                <p>âœ… <strong>è¯†åˆ«æˆåŠŸæ•°:</strong> ${stats.faces_recognized}</p>
            `;
            
            if (Object.keys(stats.person_counts).length > 0) {
                statsHtml += '<p>ğŸ“ <strong>äººç‰©å‡ºç°æ¬¡æ•°:</strong></p><ul>';
                for (const [name, count] of Object.entries(stats.person_counts)) {
                    statsHtml += `<li>${name}: ${count} æ¬¡</li>`;
                }
                statsHtml += '</ul>';
            }
            
            labelStats.innerHTML = statsHtml;
            
            // è®¾ç½®ä¸‹è½½é“¾æ¥
            labelDownloadBtn.href = data.download_url;
            labelDownloadBtn.download = data.filename;
            
            labelProcessingTime.textContent = `å¤„ç†è€—æ—¶: ${data.processing_time} ç§’`;
        }
        
        // ==================== å®æ—¶æ ‡æ³¨æ¨¡å¼ ====================
        
        const realtimeMode = document.getElementById('realtimeMode');
        const realtimePersonImageInput = document.getElementById('realtimePersonImageInput');
        const realtimePersonUploadArea = document.getElementById('realtimePersonUploadArea');
        const realtimePersonPreview = document.getElementById('realtimePersonPreview');
        const realtimePersonNameInput = document.getElementById('realtimePersonNameInput');
        const addRealtimePersonBtn = document.getElementById('addRealtimePersonBtn');
        const realtimePersonsList = document.getElementById('realtimePersonsList');
        const realtimePersonCount = document.getElementById('realtimePersonCount');
        const realtimeVideoInput = document.getElementById('realtimeVideoInput');
        const realtimeVideoUploadArea = document.getElementById('realtimeVideoUploadArea');
        const realtimeVideoPreviewContainer = document.getElementById('realtimeVideoPreviewContainer');
        const realtimeVideoPreview = document.getElementById('realtimeVideoPreview');
        const realtimeVideoInfo = document.getElementById('realtimeVideoInfo');
        const startRealtimeBtn = document.getElementById('startRealtimeBtn');
        const stopRealtimeBtn = document.getElementById('stopRealtimeBtn');
        const realtimePreviewSection = document.getElementById('realtimePreviewSection');
        const realtimeProgressBar = document.getElementById('realtimeProgressBar');
        const realtimeProgressText = document.getElementById('realtimeProgressText');
        const realtimeFrameDisplay = document.getElementById('realtimeFrameDisplay');
        const realtimeTimeInfo = document.getElementById('realtimeTimeInfo');
        const realtimeFaceInfo = document.getElementById('realtimeFaceInfo');
        const realtimeFacesList = document.getElementById('realtimeFacesList');
        const realtimeCompleteSection = document.getElementById('realtimeCompleteSection');
        const realtimeStats = document.getElementById('realtimeStats');
        const gcloudLogOutput = document.getElementById('gcloudLogOutput');
        const gcloudStatusInfo = document.getElementById('gcloudStatusInfo');
        const gcloudConfigModal = document.getElementById('gcloudConfigModal');
        
        // Gemini å¤é€‰æ¡†æ§åˆ¶æç¤ºè¯æ˜¾ç¤º
        const realtimeGeminiCheckbox = document.getElementById('realtimeGeminiCheckbox');
        const realtimeGeminiPromptSection = document.getElementById('realtimeGeminiPromptSection');
        
        realtimeGeminiCheckbox.addEventListener('change', function() {
            realtimeGeminiPromptSection.style.display = this.checked ? 'block' : 'none';
        });
        
        // è§†é¢‘å¤„ç†æ¨¡å¼åˆ‡æ¢
        const realtimeModeFrames = document.getElementById('realtimeModeFrames');
        const realtimeModeDirect = document.getElementById('realtimeModeDirect');
        const realtimeGeminiHint = document.getElementById('realtimeGeminiHint');
        const realtimeModeFramesLabel = document.getElementById('realtimeModeFramesLabel');
        const realtimeModeDirectLabel = document.getElementById('realtimeModeDirectLabel');
        
        function updateRealtimeModeUI() {
            if (realtimeModeFrames.checked) {
                realtimeModeFramesLabel.style.borderColor = '#4285f4';
                realtimeModeFramesLabel.style.background = '#e8f4fd';
                realtimeModeDirectLabel.style.borderColor = '#e0e0e0';
                realtimeModeDirectLabel.style.background = 'white';
                realtimeGeminiHint.textContent = 'ğŸ’¡ æç¤ºï¼šä¼šè‡ªåŠ¨ç»“åˆ InsightFace è¯†åˆ«åˆ°çš„äººç‰©ä¿¡æ¯è¿›è¡Œåˆ†æ';
            } else {
                realtimeModeDirectLabel.style.borderColor = '#4285f4';
                realtimeModeDirectLabel.style.background = '#e8f4fd';
                realtimeModeFramesLabel.style.borderColor = '#e0e0e0';
                realtimeModeFramesLabel.style.background = 'white';
                realtimeGeminiHint.textContent = 'ğŸ’¡ æç¤ºï¼šå°†å®Œæ•´è§†é¢‘å‘é€ç»™ Geminiï¼Œæ”¯æŒæ›´å¥½çš„æ—¶åºç†è§£';
            }
        }
        
        realtimeModeFrames.addEventListener('change', updateRealtimeModeUI);
        realtimeModeDirect.addEventListener('change', updateRealtimeModeUI);
        
        // GCloud é…ç½®å¼¹å‡ºæ¡†æ§åˆ¶
        document.getElementById('openGcloudConfigBtn').addEventListener('click', function() {
            gcloudConfigModal.style.display = 'flex';
        });
        
        document.getElementById('closeGcloudConfigBtn').addEventListener('click', function() {
            gcloudConfigModal.style.display = 'none';
        });
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹å‡ºæ¡†
        gcloudConfigModal.addEventListener('click', function(e) {
            if (e.target === gcloudConfigModal) {
                gcloudConfigModal.style.display = 'none';
            }
        });
        
        // GCloud è®¤è¯ç›¸å…³åŠŸèƒ½
        document.getElementById('setProjectBtn').addEventListener('click', async function() {
            const projectId = document.getElementById('gcloudProjectInput').value.trim();
            if (!projectId) {
                alert('è¯·è¾“å…¥ Project ID');
                return;
            }
            
            this.disabled = true;
            gcloudLogOutput.textContent = '';
            
            const formData = new FormData();
            formData.append('project_id', projectId);
            
            try {
                const response = await fetch('/api/gcloud/set_project', {
                    method: 'POST',
                    body: formData
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));
                            if (data.type === 'start') {
                                gcloudLogOutput.textContent += `$ ${data.command}\n`;
                            } else if (data.type === 'output') {
                                gcloudLogOutput.textContent += data.line + '\n';
                            } else if (data.type === 'complete') {
                                gcloudLogOutput.textContent += `\n${data.success ? 'âœ…' : 'âŒ'} ${data.message}\n`;
                            } else if (data.type === 'error') {
                                gcloudLogOutput.textContent += `\nâŒ é”™è¯¯: ${data.message}\n`;
                            }
                            gcloudLogOutput.scrollTop = gcloudLogOutput.scrollHeight;
                        }
                    }
                }
            } catch (error) {
                gcloudLogOutput.textContent += `\nâŒ è¯·æ±‚å¤±è´¥: ${error.message}\n`;
            } finally {
                this.disabled = false;
            }
        });
        
        document.getElementById('gcloudAuthBtn').addEventListener('click', async function() {
            this.disabled = true;
            gcloudLogOutput.textContent = '';
            document.getElementById('authCodeSection').style.display = 'none';
            document.getElementById('gcloudAuthCodeInput').value = '';
            
            try {
                const response = await fetch('/api/gcloud/auth', { method: 'POST' });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));
                            if (data.type === 'start') {
                                gcloudLogOutput.textContent += `$ ${data.command}\n`;
                                gcloudLogOutput.textContent += 'è¯·å¤åˆ¶ä¸‹æ–¹ URL åˆ°æµè§ˆå™¨æ‰“å¼€ï¼Œå®Œæˆ Google ç™»å½•åè·å–éªŒè¯ç ...\n\n';
                            } else if (data.type === 'output') {
                                // æ£€æµ‹æ˜¯å¦æ˜¯ URL è¡Œ
                                if (data.line.startsWith('http')) {
                                    gcloudLogOutput.textContent += 'ğŸ”— è®¤è¯é“¾æ¥ (è¯·å¤åˆ¶åˆ°æµè§ˆå™¨æ‰“å¼€):\n' + data.line + '\n\n';
                                } else {
                                    gcloudLogOutput.textContent += data.line + '\n';
                                }
                            } else if (data.type === 'waiting_code') {
                                gcloudLogOutput.textContent += '\nâ³ ç­‰å¾…è¾“å…¥éªŒè¯ç ...\n';
                                document.getElementById('authCodeSection').style.display = 'block';
                            } else if (data.type === 'complete') {
                                gcloudLogOutput.textContent += `\n${data.success ? 'âœ…' : 'âŒ'} ${data.message}\n`;
                                document.getElementById('authCodeSection').style.display = 'none';
                            } else if (data.type === 'error') {
                                gcloudLogOutput.textContent += `\nâŒ é”™è¯¯: ${data.message}\n`;
                            }
                            gcloudLogOutput.scrollTop = gcloudLogOutput.scrollHeight;
                        }
                    }
                }
            } catch (error) {
                gcloudLogOutput.textContent += `\nâŒ è¯·æ±‚å¤±è´¥: ${error.message}\n`;
            } finally {
                this.disabled = false;
            }
        });
        
        // æäº¤éªŒè¯ç 
        document.getElementById('submitAuthCodeBtn').addEventListener('click', async function() {
            const authCode = document.getElementById('gcloudAuthCodeInput').value.trim();
            if (!authCode) {
                alert('è¯·è¾“å…¥éªŒè¯ç ');
                return;
            }
            
            this.disabled = true;
            
            const formData = new FormData();
            formData.append('auth_code', authCode);
            
            try {
                const response = await fetch('/api/gcloud/auth_code', {
                    method: 'POST',
                    body: formData
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));
                            if (data.type === 'output') {
                                gcloudLogOutput.textContent += data.line + '\n';
                            } else if (data.type === 'complete') {
                                gcloudLogOutput.textContent += `\n${data.success ? 'âœ…' : 'âŒ'} ${data.message}\n`;
                                document.getElementById('authCodeSection').style.display = 'none';
                            } else if (data.type === 'error') {
                                gcloudLogOutput.textContent += `\nâŒ é”™è¯¯: ${data.message}\n`;
                            }
                            gcloudLogOutput.scrollTop = gcloudLogOutput.scrollHeight;
                        }
                    }
                }
            } catch (error) {
                gcloudLogOutput.textContent += `\nâŒ è¯·æ±‚å¤±è´¥: ${error.message}\n`;
            } finally {
                this.disabled = false;
            }
        });
        
        document.getElementById('checkGcloudStatusBtn').addEventListener('click', async function() {
            this.disabled = true;
            
            try {
                const response = await fetch('/api/gcloud/status');
                const data = await response.json();
                
                if (data.success) {
                    gcloudStatusInfo.style.display = 'block';
                    gcloudStatusInfo.style.background = data.authenticated ? '#d4edda' : '#fff3cd';
                    gcloudStatusInfo.style.color = data.authenticated ? '#155724' : '#856404';
                    gcloudStatusInfo.innerHTML = `
                        <strong>ğŸ“Š å½“å‰çŠ¶æ€:</strong><br>
                        â€¢ é¡¹ç›®: ${data.project || 'æœªè®¾ç½®'}<br>
                        â€¢ è´¦å·: ${data.account || 'æœªè®¾ç½®'}<br>
                        â€¢ è®¤è¯: ${data.authenticated ? 'âœ… å·²è®¤è¯' : 'âŒ æœªè®¤è¯'}
                    `;
                } else {
                    gcloudStatusInfo.style.display = 'block';
                    gcloudStatusInfo.style.background = '#f8d7da';
                    gcloudStatusInfo.style.color = '#721c24';
                    gcloudStatusInfo.textContent = `âŒ æ£€æŸ¥å¤±è´¥: ${data.error}`;
                }
            } catch (error) {
                gcloudStatusInfo.style.display = 'block';
                gcloudStatusInfo.style.background = '#f8d7da';
                gcloudStatusInfo.style.color = '#721c24';
                gcloudStatusInfo.textContent = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            } finally {
                this.disabled = false;
            }
        });
        
        let realtimeSessionId = null;
        let realtimePersons = []; // å­˜å‚¨ {name, imageData} å¯¹è±¡
        let realtimeSelectedImageData = null;
        let realtimeSelectedVideo = null;
        let realtimeEventSource = null;
        let realtimePersonCounts = {};
        let realtimeUnknownCount = 0;
        let realtimeFrameDetails = [];
        let realtimeTotalFrames = 0;
        let realtimeProcessedFrames = 0;
        
        // åˆ›å»ºå®æ—¶æ ‡æ³¨ä¼šè¯
        async function createRealtimeSession() {
            try {
                const response = await fetch('/api/realtime/create_session', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    realtimeSessionId = data.session_id;
                    console.log('å®æ—¶æ ‡æ³¨ä¼šè¯å·²åˆ›å»º:', realtimeSessionId);
                }
            } catch (error) {
                console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
            }
        }
        
        // ç›‘å¬æ¨¡å¼åˆ‡æ¢
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const mode = this.dataset.mode;
                if (mode === 'realtime' && !realtimeSessionId) {
                    createRealtimeSession();
                    realtimePersons = [];
                    updateRealtimePersonsList();
                }
            });
        });
        
        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        realtimePersonUploadArea.addEventListener('click', () => realtimePersonImageInput.click());
        
        // é€‰æ‹©ç…§ç‰‡
        realtimePersonImageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    realtimeSelectedImageData = e.target.result;
                    realtimePersonPreview.src = realtimeSelectedImageData;
                    realtimePersonPreview.style.display = 'block';
                    updateAddRealtimePersonBtnState();
                };
                reader.readAsDataURL(file);
            }
        });
        
        // åå­—è¾“å…¥
        realtimePersonNameInput.addEventListener('input', updateAddRealtimePersonBtnState);
        
        function updateAddRealtimePersonBtnState() {
            const hasImage = realtimeSelectedImageData !== null;
            const hasName = realtimePersonNameInput.value.trim().length > 0;
            addRealtimePersonBtn.disabled = !(hasImage && hasName);
        }
        
        // æ·»åŠ äººç‰©
        addRealtimePersonBtn.addEventListener('click', async function() {
            if (!realtimeSessionId) {
                await createRealtimeSession();
            }
            
            const name = realtimePersonNameInput.value.trim();
            if (!name || !realtimeSelectedImageData) return;
            
            if (!/^[a-zA-Z0-9_]+$/.test(name)) {
                alert('åå­—åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
                return;
            }
            
            if (realtimePersons.some(p => p.name === name)) {
                alert('è¯¥åå­—å·²å­˜åœ¨');
                return;
            }
            
            addRealtimePersonBtn.disabled = true;
            addRealtimePersonBtn.textContent = 'æ·»åŠ ä¸­...';
            
            try {
                const formData = new FormData();
                formData.append('session_id', realtimeSessionId);
                formData.append('name', name);
                
                const base64Data = realtimeSelectedImageData.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteArray = new Uint8Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteArray[i] = byteCharacters.charCodeAt(i);
                }
                const blob = new Blob([byteArray], { type: 'image/jpeg' });
                formData.append('image', blob, 'photo.jpg');
                
                const response = await fetch('/api/realtime/add_person', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    realtimePersons.push({name: name, imageData: realtimeSelectedImageData});
                    updateRealtimePersonsList();
                    
                    realtimePersonNameInput.value = '';
                    realtimeSelectedImageData = null;
                    realtimePersonPreview.style.display = 'none';
                    realtimePersonImageInput.value = '';
                } else {
                    alert(data.error || 'æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            } finally {
                addRealtimePersonBtn.disabled = false;
                addRealtimePersonBtn.textContent = 'æ·»åŠ ';
                updateAddRealtimePersonBtnState();
                updateStartRealtimeBtnState();
            }
        });
        
        // æ›´æ–°äººç‰©åˆ—è¡¨æ˜¾ç¤º
        function updateRealtimePersonsList() {
            realtimePersonCount.textContent = realtimePersons.length;
            
            if (realtimePersons.length === 0) {
                realtimePersonsList.innerHTML = '<p class="no-persons-text">æš‚æœªæ·»åŠ äººç‰©</p>';
            } else {
                realtimePersonsList.innerHTML = realtimePersons.map(person => `
                    <div class="person-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 8px; margin-bottom: 6px;">
                        <img src="${person.imageData}" alt="${person.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid #4CAF50;">
                        <span class="person-name" style="flex: 1; font-weight: 500;">${person.name}</span>
                        <button class="remove-person-btn" data-name="${person.name}" style="background: #ff5252; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">Ã—</button>
                    </div>
                `).join('');
                
                realtimePersonsList.querySelectorAll('.remove-person-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        removeRealtimePerson(this.dataset.name);
                    });
                });
            }
        }
        
        // ç§»é™¤äººç‰©
        async function removeRealtimePerson(name) {
            try {
                const formData = new FormData();
                formData.append('session_id', realtimeSessionId);
                formData.append('name', name);
                
                await fetch('/api/realtime/remove_person', {
                    method: 'POST',
                    body: formData
                });
                
                realtimePersons = realtimePersons.filter(p => p.name !== name);
                updateRealtimePersonsList();
                updateStartRealtimeBtnState();
            } catch (error) {
                console.error('ç§»é™¤å¤±è´¥:', error);
            }
        }
        
        // è§†é¢‘ä¸Šä¼ 
        realtimeVideoUploadArea.addEventListener('click', () => realtimeVideoInput.click());
        
        realtimeVideoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            realtimeVideoUploadArea.classList.add('drag-over');
        });
        
        realtimeVideoUploadArea.addEventListener('dragleave', () => {
            realtimeVideoUploadArea.classList.remove('drag-over');
        });
        
        realtimeVideoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            realtimeVideoUploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                handleRealtimeVideoSelect(file);
            }
        });
        
        realtimeVideoInput.addEventListener('change', function() {
            if (this.files[0]) {
                handleRealtimeVideoSelect(this.files[0]);
            }
        });
        
        function handleRealtimeVideoSelect(file) {
            realtimeSelectedVideo = file;
            realtimeVideoPreview.src = URL.createObjectURL(file);
            realtimeVideoPreviewContainer.style.display = 'block';
            realtimeVideoInfo.textContent = `æ–‡ä»¶: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            realtimeVideoUploadArea.style.display = 'none';
            updateStartRealtimeBtnState();
        }
        
        // æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
        function updateStartRealtimeBtnState() {
            startRealtimeBtn.disabled = !(realtimePersons.length > 0 && realtimeSelectedVideo);
        }
        
        // å¼€å§‹å®æ—¶æ ‡æ³¨
        startRealtimeBtn.addEventListener('click', async function() {
            if (!realtimeSessionId || realtimePersons.length === 0 || !realtimeSelectedVideo) {
                return;
            }
            
            startRealtimeBtn.style.display = 'none';
            stopRealtimeBtn.style.display = 'inline-block';
            realtimePreviewSection.style.display = 'block';
            realtimeCompleteSection.style.display = 'none';
            realtimeProgressBar.style.width = '0%';
            realtimeProgressText.textContent = 'æ­£åœ¨ä¸Šä¼ è§†é¢‘...';
            realtimeFrameDisplay.style.display = 'none';
            
            // åˆå§‹åŒ–ç»Ÿè®¡å˜é‡
            realtimePersonCounts = {};
            realtimeUnknownCount = 0;
            realtimeFrameDetails = [];
            realtimeTotalFrames = 0;
            realtimeProcessedFrames = 0;
            document.getElementById('realtimeJsonStats').textContent = 'ç­‰å¾…æ•°æ®...';
            document.getElementById('realtimeGeminiResult').style.display = 'none';
            document.getElementById('realtimeTokenStats').style.display = 'none';
            
            const formData = new FormData();
            formData.append('session_id', realtimeSessionId);
            formData.append('video', realtimeSelectedVideo);
            formData.append('threshold', document.getElementById('realtimeThresholdInput').value / 100);
            formData.append('show_unknown', document.getElementById('realtimeShowUnknownCheckbox').checked);
            formData.append('target_fps', document.getElementById('realtimeFpsInput').value);
            formData.append('enable_gemini', document.getElementById('realtimeGeminiCheckbox').checked);
            formData.append('gemini_prompt', document.getElementById('realtimeGeminiPrompt').value.trim());
            formData.append('gemini_mode', document.querySelector('input[name="realtimeVideoMode"]:checked').value);
            
            try {
                const response = await fetch('/api/realtime/stream', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'è¯·æ±‚å¤±è´¥');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                handleRealtimeData(data);
                            } catch (e) {
                                console.error('è§£ææ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                realtimeProgressText.textContent = 'å¤„ç†å¤±è´¥: ' + error.message;
            } finally {
                startRealtimeBtn.style.display = 'inline-block';
                stopRealtimeBtn.style.display = 'none';
            }
        });
        
        // å¤„ç†å®æ—¶æ•°æ®
        // æ›´æ–°å®æ—¶JSONç»Ÿè®¡æ˜¾ç¤º
        function updateRealtimeJsonStats() {
            const ownerList = Object.keys(realtimePersonCounts);
            const ownerTotalCount = Object.values(realtimePersonCounts).reduce((a, b) => a + b, 0);
            
            const stats = {
                "è§†é¢‘ç»Ÿè®¡": {
                    "å¤„ç†å¸§æ•°": realtimeProcessedFrames,
                    "æ€»å¸§æ•°": realtimeTotalFrames
                },
                "Ownerç»Ÿè®¡": {
                    "Owneræ€»å‡ºç°æ¬¡æ•°": ownerTotalCount,
                    "Owneräººæ•°": ownerList.length,
                    "Owneråˆ—è¡¨": ownerList,
                    "å„Ownerå‡ºç°æ¬¡æ•°": realtimePersonCounts
                },
                "é™Œç”Ÿäººç»Ÿè®¡": {
                    "é™Œç”Ÿäººå‡ºç°æ¬¡æ•°": realtimeUnknownCount,
                    "é™Œç”Ÿäººç±»å‹æ•°": realtimeUnknownCount > 0 ? 1 : 0
                },
                "æ€»ç»“": {
                    "è¯†åˆ«åˆ°çš„äººè„¸æ€»æ¬¡æ•°": ownerTotalCount + realtimeUnknownCount,
                    "å…¶ä¸­Owner": ownerTotalCount,
                    "å…¶ä¸­é™Œç”Ÿäºº": realtimeUnknownCount
                }
            };
            
            // åªä¿ç•™æœ€è¿‘10ä¸ªå¸§è¯¦æƒ…ï¼ˆé˜²æ­¢æ•°æ®è¿‡å¤§ï¼‰
            if (realtimeFrameDetails.length > 0) {
                stats["æœ€è¿‘å¸§è¯¦æƒ…"] = realtimeFrameDetails.slice(-10);
            }
            
            document.getElementById('realtimeJsonStats').textContent = JSON.stringify(stats, null, 2);
        }
        
        // æ ¼å¼åŒ–äººç‰©åœºæ™¯åˆ†æç»“æœ
        function formatPersonSceneAnalysis(analysis) {
            if (!analysis) return '';
            
            // è§£æåˆ†æç»“æœï¼ŒæŒ‰äººç‰©åˆ†ç»„æ˜¾ç¤º
            const lines = analysis.split('\n');
            let html = '';
            let currentPerson = '';
            let currentContent = [];
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                
                // æ£€æµ‹äººç‰©æ ‡é¢˜è¡Œ (â”â”â” äººå â”â”â”)
                const personMatch = trimmedLine.match(/^â”+\s*(.+?)\s*â”+$/);
                if (personMatch) {
                    // è¾“å‡ºä¸Šä¸€ä¸ªäººç‰©çš„å†…å®¹
                    if (currentPerson && currentContent.length > 0) {
                        html += renderPersonCard(currentPerson, currentContent);
                    }
                    currentPerson = personMatch[1];
                    currentContent = [];
                    continue;
                }
                
                // æ£€æµ‹æ ‡é¢˜è¡Œ
                if (trimmedLine.startsWith('ã€') && trimmedLine.endsWith('ã€‘')) {
                    continue; // è·³è¿‡æ€»æ ‡é¢˜
                }
                
                // æ”¶é›†å†…å®¹è¡Œ
                if (trimmedLine && currentPerson) {
                    currentContent.push(trimmedLine);
                }
            }
            
            // è¾“å‡ºæœ€åä¸€ä¸ªäººç‰©çš„å†…å®¹
            if (currentPerson && currentContent.length > 0) {
                html += renderPersonCard(currentPerson, currentContent);
            }
            
            // å¦‚æœæ²¡æœ‰è§£æåˆ°ç»“æ„åŒ–å†…å®¹ï¼Œç›´æ¥æ˜¾ç¤ºåŸæ–‡
            if (!html) {
                html = `<pre style="white-space: pre-wrap; margin: 0; font-family: inherit;">${analysis}</pre>`;
            }
            
            return html;
        }
        
        // æ¸²æŸ“å•ä¸ªäººç‰©çš„åœºæ™¯å¡ç‰‡
        function renderPersonCard(personName, contentLines) {
            let timePoints = '';
            let sceneAnalysis = [];
            
            for (const line of contentLines) {
                // æ£€æµ‹æ—¶é—´ç‚¹è¡Œ
                if (line.startsWith('å‡ºç°æ—¶é—´ç‚¹:') || line.startsWith('å‡ºç°æ—¶é—´ç‚¹ï¼š')) {
                    timePoints = line.replace(/^å‡ºç°æ—¶é—´ç‚¹[:ï¼š]\s*/, '');
                } else if (line) {
                    // åœºæ™¯æè¿°è¡Œ
                    sceneAnalysis.push(line);
                }
            }
            
            // æ ¼å¼åŒ–åœºæ™¯æè¿°
            let sceneHtml = '';
            for (const scene of sceneAnalysis) {
                // å°è¯•è§£æ [æ—¶é—´] - [æè¿°] æ ¼å¼
                const timeMatch = scene.match(/^\[?(\d{2}:\d{2})\]?\s*[-â€“â€”]\s*(.+)$/);
                if (timeMatch) {
                    sceneHtml += `
                        <div style="display: flex; margin: 8px 0; align-items: flex-start;">
                            <span style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; min-width: 50px; text-align: center;">${timeMatch[1]}</span>
                            <span style="margin-left: 10px; color: #333;">${timeMatch[2]}</span>
                        </div>`;
                } else if (scene.trim()) {
                    sceneHtml += `<div style="margin: 6px 0; color: #555;">${scene}</div>`;
                }
            }
            
            return `
                <div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 20px; margin-right: 8px;">ğŸ‘¤</span>
                        <span style="font-size: 16px; font-weight: bold; color: #1a73e8;">${personName}</span>
                    </div>
                    ${timePoints ? `<div style="font-size: 12px; color: #888; margin-bottom: 10px;">â±ï¸ å‡ºç°æ—¶é—´: ${timePoints}</div>` : ''}
                    <div style="border-top: 1px solid #eee; padding-top: 10px;">
                        ${sceneHtml || '<div style="color: #888;">æš‚æ— åœºæ™¯æè¿°</div>'}
                    </div>
                </div>`;
        }
        
        function handleRealtimeData(data) {
            if (data.error) {
                realtimeProgressText.textContent = 'é”™è¯¯: ' + data.error;
                return;
            }
            
            if (data.type === 'info') {
                realtimeTotalFrames = data.total_frames;
                realtimeProgressText.textContent = `è§†é¢‘ä¿¡æ¯: ${data.total_frames} å¸§, ${data.video_fps.toFixed(1)} fps`;
                updateRealtimeJsonStats();
            } else if (data.type === 'frame') {
                // æ˜¾ç¤ºå¸§
                realtimeFrameDisplay.src = 'data:image/jpeg;base64,' + data.image_base64;
                realtimeFrameDisplay.style.display = 'block';
                
                // æ›´æ–°è¿›åº¦
                realtimeProgressBar.style.width = data.progress + '%';
                realtimeProgressText.textContent = `è¿›åº¦: ${data.progress}% (${data.frame_index}/${data.total_frames})`;
                realtimeTimeInfo.textContent = `æ—¶é—´: ${data.current_time}s`;
                realtimeFaceInfo.textContent = `æ£€æµ‹åˆ°: ${data.faces.length} äºº`;
                
                realtimeProcessedFrames++;
                
                // è®°å½•å¸§è¯¦æƒ…
                const frameInfo = {
                    "å¸§": data.frame_index,
                    "æ—¶é—´": data.current_time + "s",
                    "äººè„¸": []
                };
                
                // æ›´æ–°äººè„¸æ ‡ç­¾
                let facesHtml = '';
                data.faces.forEach(face => {
                    const isRecognized = face.name !== 'Unknown';
                    const className = isRecognized ? 'recognized' : 'unknown';
                    const label = isRecognized ? `${face.name} ${(face.similarity * 100).toFixed(0)}%` : 'Unknown';
                    facesHtml += `<span class="realtime-face-tag ${className}">${label}</span>`;
                    
                    // ç»Ÿè®¡
                    if (isRecognized) {
                        realtimePersonCounts[face.name] = (realtimePersonCounts[face.name] || 0) + 1;
                        frameInfo["äººè„¸"].push(face.name);
                    } else {
                        realtimeUnknownCount++;
                        frameInfo["äººè„¸"].push("Unknown");
                    }
                });
                realtimeFacesList.innerHTML = facesHtml;
                
                // åªè®°å½•æœ‰äººè„¸çš„å¸§
                if (frameInfo["äººè„¸"].length > 0) {
                    realtimeFrameDetails.push(frameInfo);
                }
                
                // å®æ—¶æ›´æ–°JSONç»Ÿè®¡
                updateRealtimeJsonStats();
                
            } else if (data.type === 'complete') {
                realtimeProgressBar.style.width = '100%';
                realtimeProgressText.textContent = 'æ ‡æ³¨å®Œæˆ!';
                
                // æ˜¾ç¤ºç»Ÿè®¡
                realtimeCompleteSection.style.display = 'block';
                
                const ownerList = Object.keys(realtimePersonCounts);
                const ownerTotalCount = Object.values(realtimePersonCounts).reduce((a, b) => a + b, 0);
                
                let statsHtml = `
                    <p>ğŸ“Š <strong>å¤„ç†å¸§æ•°:</strong> ${data.processed_count} / ${data.total_frames}</p>
                    <p>ğŸ‘¥ <strong>Owneräººæ•°:</strong> ${ownerList.length} äºº</p>
                    <p>ğŸ“ <strong>Owneræ€»å‡ºç°:</strong> ${ownerTotalCount} æ¬¡</p>
                `;
                
                statsHtml += `<p>ğŸ‘¤ <strong>é™Œç”Ÿäººäººæ•°:</strong> ${realtimeUnknownCount > 0 ? 1 : 0} äºº</p>`;
                statsHtml += `<p>âš ï¸ <strong>é™Œç”Ÿäººå‡ºç°:</strong> ${realtimeUnknownCount} æ¬¡</p>`;
                
                realtimeStats.innerHTML = statsHtml;
                
                // æ˜¾ç¤ºGeminiåˆ†æç»“æœ
                if (data.gemini_analysis) {
                    document.getElementById('realtimeGeminiResult').style.display = 'block';
                    document.getElementById('realtimeGeminiContent').innerHTML = 
                        '<pre style="white-space: pre-wrap; margin: 0;">' + data.gemini_analysis + '</pre>';
                }
            } else if (data.type === 'gemini_analyzing') {
                // Geminiæ­£åœ¨åˆ†æä¸­
                realtimeProgressText.textContent = 'ğŸ¤– Gemini äººç‰©åœºæ™¯åˆ†æä¸­ï¼Œè¯·ç¨å€™...';
                document.getElementById('realtimeGeminiResult').style.display = 'block';
                document.getElementById('realtimeGeminiContent').innerHTML = 
                    '<div style="text-align: center; padding: 20px;"><span style="font-size: 24px;">â³</span><br>æ­£åœ¨åˆ†ææ ‡æ³¨äººç‰©çš„å‡ºåœºåœºæ™¯...</div>';
            } else if (data.type === 'gemini_complete') {
                // Geminiåˆ†æå®Œæˆ
                realtimeProgressText.textContent = 'âœ… å…¨éƒ¨å®Œæˆ!';
                if (data.gemini_analysis) {
                    // æ ¼å¼åŒ–äººç‰©åœºæ™¯åˆ†æç»“æœ
                    const analysisHtml = formatPersonSceneAnalysis(data.gemini_analysis);
                    document.getElementById('realtimeGeminiContent').innerHTML = analysisHtml;
                }
                
                // æ˜¾ç¤º Token ç»Ÿè®¡ä¿¡æ¯
                if (data.token_stats && Object.keys(data.token_stats).length > 0) {
                    const stats = data.token_stats;
                    document.getElementById('realtimeTokenStats').style.display = 'block';
                    document.getElementById('realtimeInputTokens').textContent = stats.input_tokens || 0;
                    document.getElementById('realtimeOutputTokens').textContent = stats.output_tokens || 0;
                    document.getElementById('realtimeTotalTokens').textContent = stats.total_tokens || 0;
                    document.getElementById('realtimePersonsAnalyzed').textContent = stats.persons_analyzed || 0;
                    
                    // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒä¿¡æ¯
                    const framesInfo = document.getElementById('realtimeFramesAnalyzed');
                    if (stats.mode === 'direct') {
                        framesInfo.textContent = 'å®Œæ•´è§†é¢‘';
                        framesInfo.parentElement.innerHTML = 'ğŸ¬ å¤„ç†æ¨¡å¼: <strong>ç›´æ¥å‘é€è§†é¢‘</strong>';
                    } else {
                        framesInfo.textContent = stats.frames_analyzed || 0;
                    }
                }
            }
        }
        
        // åœæ­¢å®æ—¶æ ‡æ³¨
        stopRealtimeBtn.addEventListener('click', function() {
            // ç›®å‰ SSE ä¸æ”¯æŒä¸­é€”å–æ¶ˆï¼Œåªèƒ½åˆ·æ–°é¡µé¢
            if (confirm('ç¡®å®šè¦åœæ­¢å—ï¼Ÿ')) {
                location.reload();
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥ InsightFace çŠ¶æ€
            fetch('/api/face/status')
                .then(res => res.json())
                .then(data => {
                    if (!data.insightface_available) {
                        console.warn('InsightFace æ¨¡å—æœªå®‰è£…');
                    }
                })
                .catch(err => console.error('æ£€æŸ¥ InsightFace çŠ¶æ€å¤±è´¥:', err));
        });
        
        // ==================== è§†é¢‘Cacheæ¨¡å¼ ====================
        
        const cacheMode = document.getElementById('cacheMode');
        const cachePersonUploadArea = document.getElementById('cachePersonUploadArea');
        const cachePersonImageInput = document.getElementById('cachePersonImageInput');
        const cachePersonNameInput = document.getElementById('cachePersonNameInput');
        const cacheAddPersonBtn = document.getElementById('cacheAddPersonBtn');
        const cachePersonList = document.getElementById('cachePersonList');
        const cacheVideoUploadArea = document.getElementById('cacheVideoUploadArea');
        const cacheVideoInput = document.getElementById('cacheVideoInput');
        const cacheVideoPreview = document.getElementById('cacheVideoPreview');
        const cacheVideoPlayer = document.getElementById('cacheVideoPlayer');
        const cacheVideoInfo = document.getElementById('cacheVideoInfo');
        const createCacheBtn = document.getElementById('createCacheBtn');
        const cacheStatusArea = document.getElementById('cacheStatusArea');
        const cacheIdDisplay = document.getElementById('cacheIdDisplay');
        const cacheCreatedAt = document.getElementById('cacheCreatedAt');
        const cacheExpiresAt = document.getElementById('cacheExpiresAt');
        const cacheTotalTokens = document.getElementById('cacheTotalTokens');
        const deleteCacheBtn = document.getElementById('deleteCacheBtn');
        const cacheQueryInput = document.getElementById('cacheQueryInput');
        const sendCacheQueryBtn = document.getElementById('sendCacheQueryBtn');
        const cacheTokenStats = document.getElementById('cacheTokenStats');
        const cacheResultArea = document.getElementById('cacheResultArea');
        const cacheResultContent = document.getElementById('cacheResultContent');
        const cacheHistoryList = document.getElementById('cacheHistoryList');
        
        // çŠ¶æ€å˜é‡
        let cachePersons = [];
        let cacheSelectedVideo = null;
        let currentCacheId = null;
        let cacheQueryHistory = [];
        
        // äººç‰©ç…§ç‰‡ä¸Šä¼ 
        cachePersonUploadArea.addEventListener('click', () => cachePersonImageInput.click());
        
        cachePersonImageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    cachePersonUploadArea.querySelector('.upload-icon').textContent = 'âœ…';
                    cachePersonUploadArea.querySelector('.upload-text').textContent = file.name.substring(0, 15) + '...';
                    cachePersonUploadArea.dataset.imageData = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // æ·»åŠ äººç‰©
        cacheAddPersonBtn.addEventListener('click', function() {
            const name = cachePersonNameInput.value.trim();
            const imageData = cachePersonUploadArea.dataset.imageData;
            
            if (!name) {
                alert('è¯·è¾“å…¥äººç‰©åç§°');
                return;
            }
            
            if (!imageData) {
                alert('è¯·ä¸Šä¼ äººç‰©ç…§ç‰‡ï¼è§†é¢‘Cacheæ¨¡å—éœ€è¦ç…§ç‰‡æ‰èƒ½è¿›è¡Œäººè„¸åŒ¹é…ã€‚');
                return;
            }
            
            console.log('æ·»åŠ äººç‰©:', name, 'imageDataé•¿åº¦:', imageData ? imageData.length : 0);
            cachePersons.push({ name, imageData: imageData });
            console.log('cachePersons æ•°ç»„:', cachePersons.map(p => ({ name: p.name, hasImageData: !!p.imageData })));
            renderCachePersonList();
            
            // é‡ç½®è¾“å…¥
            cachePersonNameInput.value = '';
            cachePersonUploadArea.querySelector('.upload-icon').textContent = 'ğŸ“·';
            cachePersonUploadArea.querySelector('.upload-text').textContent = 'ç‚¹å‡»ä¸Šä¼ äººç‰©ç…§ç‰‡';
            delete cachePersonUploadArea.dataset.imageData;
            cachePersonImageInput.value = '';
        });
        
        function renderCachePersonList() {
            cachePersonList.innerHTML = cachePersons.map((p, i) => `
                <div style="display: inline-flex; align-items: center; gap: 8px; background: white; padding: 8px 12px; border-radius: 20px; border: 2px solid #ffb74d;">
                    ${p.imageData ? `<img src="${p.imageData}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">` : '<span style="font-size: 20px;">ğŸ‘¤</span>'}
                    <span style="font-weight: 600; color: #e65100;">${p.name}</span>
                    <button onclick="removeCachePerson(${i})" style="background: none; border: none; cursor: pointer; font-size: 16px;">âŒ</button>
                </div>
            `).join('');
        }
        
        window.removeCachePerson = function(index) {
            cachePersons.splice(index, 1);
            renderCachePersonList();
        };
        
        // è§†é¢‘ä¸Šä¼ 
        cacheVideoUploadArea.addEventListener('click', () => cacheVideoInput.click());
        cacheVideoUploadArea.addEventListener('dragover', e => { e.preventDefault(); cacheVideoUploadArea.style.borderColor = '#2196f3'; });
        cacheVideoUploadArea.addEventListener('dragleave', () => { cacheVideoUploadArea.style.borderColor = '#64b5f6'; });
        cacheVideoUploadArea.addEventListener('drop', e => {
            e.preventDefault();
            cacheVideoUploadArea.style.borderColor = '#64b5f6';
            if (e.dataTransfer.files.length > 0) {
                cacheVideoInput.files = e.dataTransfer.files;
                cacheVideoInput.dispatchEvent(new Event('change'));
            }
        });
        
        cacheVideoInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                cacheSelectedVideo = this.files[0];
                const url = URL.createObjectURL(cacheSelectedVideo);
                cacheVideoPlayer.src = url;
                cacheVideoPreview.style.display = 'block';
                cacheVideoInfo.textContent = `æ–‡ä»¶: ${cacheSelectedVideo.name} | å¤§å°: ${(cacheSelectedVideo.size / 1024 / 1024).toFixed(2)} MB`;
                createCacheBtn.disabled = false;
            }
        });
        
        // åˆ›å»º Cache
        createCacheBtn.addEventListener('click', async function() {
            if (!cacheSelectedVideo) {
                alert('è¯·å…ˆä¸Šä¼ è§†é¢‘');
                return;
            }
            
            createCacheBtn.disabled = true;
            
            // æ ¹æ®æ˜¯å¦æœ‰ Owner ç…§ç‰‡æ˜¾ç¤ºä¸åŒçš„è¿›åº¦æç¤º
            if (cachePersons.length > 0 && cachePersons.some(p => p.imageData)) {
                createCacheBtn.textContent = 'â³ æ‰«æäººè„¸ä¸­...';
            } else {
                createCacheBtn.textContent = 'â³ åˆ›å»ºä¸­...';
            }
            
            const formData = new FormData();
            formData.append('video', cacheSelectedVideo);
            // å‘é€å®Œæ•´çš„ Owner æ•°æ®ï¼ˆåŒ…å«ç…§ç‰‡ï¼‰
            const ownerDataToSend = cachePersons.map(p => ({
                name: p.name,
                imageData: p.imageData || null
            }));
            console.log('å‘é€çš„ Owner æ•°æ®:', ownerDataToSend.map(o => ({ name: o.name, hasImageData: !!o.imageData, imageDataLength: o.imageData ? o.imageData.length : 0 })));
            formData.append('owner_data', JSON.stringify(ownerDataToSend));
            formData.append('target_fps', '2.0');
            formData.append('base_prompt', document.getElementById('cacheBasePrompt').value.trim());
            
            try {
                const response = await fetch('/api/cache/create', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentCacheId = data.cache_id;
                    cacheIdDisplay.textContent = data.cache_id;
                    cacheCreatedAt.textContent = data.created_at;
                    cacheExpiresAt.textContent = data.expires_at;
                    cacheTotalTokens.textContent = data.usage_metadata?.total_token_count || '-';
                    
                    // æ˜¾ç¤ºäººè„¸è¯†åˆ«ç»“æœ
                    if (data.owner_recognition) {
                        const recog = data.owner_recognition;
                        
                        // æ„å»ºè¯¦ç»†çš„è¯†åˆ«ç»“æœ
                        let recogHtml = `<strong>ğŸ‘¤ äººè„¸è¯†åˆ«ç»“æœ:</strong> è¯†åˆ«åˆ° ${recog.recognized_count}/${recog.owners_count} ä¸ª Owner`;
                        
                        // æ˜¾ç¤ºæ¯ä¸ªOwnerçš„è¯¦ç»†çŠ¶æ€
                        if (recog.details && Object.keys(recog.details).length > 0) {
                            recogHtml += '<div style="margin-top: 8px; padding: 10px; background: #f5f5f5; border-radius: 6px;">';
                            for (const [name, detail] of Object.entries(recog.details)) {
                                let statusIcon = 'âŒ';
                                let statusColor = '#d32f2f';
                                
                                if (detail.recognized_in_video) {
                                    statusIcon = 'âœ…';
                                    statusColor = '#2e7d32';
                                } else if (detail.face_extracted) {
                                    statusIcon = 'âš ï¸';
                                    statusColor = '#f57c00';
                                } else if (detail.has_photo) {
                                    statusIcon = 'âŒ';
                                    statusColor = '#d32f2f';
                                } else {
                                    statusIcon = 'ğŸ“·';
                                    statusColor = '#757575';
                                }
                                
                                recogHtml += `<div style="margin: 4px 0; font-size: 12px;">`;
                                recogHtml += `<span style="color: ${statusColor};">${statusIcon}</span> `;
                                recogHtml += `<strong>${name}</strong>: ${detail.status}`;
                                recogHtml += `</div>`;
                            }
                            recogHtml += '</div>';
                        }
                        
                        // æ·»åŠ è¯†åˆ«ç»“æœæ˜¾ç¤º
                        let recogEl = document.getElementById('cacheRecognitionResult');
                        if (!recogEl) {
                            recogEl = document.createElement('div');
                            recogEl.id = 'cacheRecognitionResult';
                            recogEl.style.cssText = 'font-size: 13px; margin: 10px 0; color: #1565c0;';
                            cacheStatusArea.querySelector('h5').after(recogEl);
                        }
                        recogEl.innerHTML = recogHtml;
                    }
                    
                    cacheStatusArea.style.display = 'block';
                    sendCacheQueryBtn.disabled = false;
                    createCacheBtn.textContent = 'âœ… Cache å·²åˆ›å»º';
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + data.error);
                    createCacheBtn.disabled = false;
                    createCacheBtn.textContent = 'ğŸ“¦ åˆ›å»º Cache';
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
                createCacheBtn.disabled = false;
                createCacheBtn.textContent = 'ğŸ“¦ åˆ›å»º Cache';
            }
        });
        
        // åˆ é™¤ Cache
        deleteCacheBtn.addEventListener('click', async function() {
            if (!currentCacheId) return;
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ Cache å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/api/cache/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cache_id: currentCacheId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentCacheId = null;
                    cacheStatusArea.style.display = 'none';
                    sendCacheQueryBtn.disabled = true;
                    createCacheBtn.disabled = false;
                    createCacheBtn.textContent = 'ğŸ“¦ åˆ›å»º Cache';
                    cacheQueryHistory = [];
                    cacheHistoryList.innerHTML = '';
                    alert('Cache å·²åˆ é™¤');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        });
        
        // å‘é€æŸ¥è¯¢
        sendCacheQueryBtn.addEventListener('click', async function() {
            const query = cacheQueryInput.value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢é—®é¢˜');
                return;
            }
            if (!currentCacheId) {
                alert('è¯·å…ˆåˆ›å»º Cache');
                return;
            }
            
            sendCacheQueryBtn.disabled = true;
            sendCacheQueryBtn.textContent = 'â³ åˆ†æä¸­...';
            
            try {
                const response = await fetch('/api/cache/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cache_id: currentCacheId,
                        query: query
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // æ˜¾ç¤ºç»“æœ
                    cacheResultContent.textContent = data.analysis;
                    cacheResultArea.style.display = 'block';
                    
                    // æ˜¾ç¤º Token ç»Ÿè®¡
                    if (data.token_stats) {
                        const cachedTokens = data.token_stats.cached_content_token_count || 0;
                        const promptTokens = data.token_stats.prompt_token_count || 0;
                        const outputTokens = data.token_stats.candidates_token_count || 0;
                        
                        // è®¡ç®—ï¼šæœ¬æ¬¡é—®é¢˜ Token = æ€»è¾“å…¥ - ç¼“å­˜å†…å®¹
                        const newInputTokens = Math.max(0, promptTokens - cachedTokens);
                        // èŠ‚çœçš„ Token = ç¼“å­˜å†…å®¹ï¼ˆå› ä¸ºä¸ç”¨é‡å¤è®¡ç®—ï¼‰
                        const savedTokens = cachedTokens;
                        
                        document.getElementById('statCachedTokens').textContent = cachedTokens.toLocaleString();
                        document.getElementById('statNewInputTokens').textContent = newInputTokens.toLocaleString();
                        document.getElementById('statOutputTokens').textContent = outputTokens.toLocaleString();
                        document.getElementById('statSavedTokens').textContent = savedTokens.toLocaleString();
                        document.getElementById('statCachedTokensRef').textContent = cachedTokens.toLocaleString();
                        document.getElementById('statNewInputTokensRef').textContent = newInputTokens.toLocaleString();
                        cacheTokenStats.style.display = 'block';
                    }
                    
                    // æ·»åŠ åˆ°å†å²ï¼ˆæ˜¾ç¤ºå®é™…æ¶ˆè€—çš„æ–°è¾“å…¥ Tokenï¼‰
                    const historyNewTokens = Math.max(0, (data.token_stats?.prompt_token_count || 0) - (data.token_stats?.cached_content_token_count || 0));
                    cacheQueryHistory.unshift({
                        query: query,
                        time: new Date().toLocaleTimeString(),
                        newTokens: historyNewTokens,
                        outputTokens: data.token_stats?.candidates_token_count || 0
                    });
                    renderCacheHistory();
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    cacheQueryInput.value = '';
                } else {
                    alert('æŸ¥è¯¢å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                sendCacheQueryBtn.disabled = false;
                sendCacheQueryBtn.textContent = 'ğŸ” å‘é€æŸ¥è¯¢';
            }
        });
        
        function renderCacheHistory() {
            cacheHistoryList.innerHTML = cacheQueryHistory.map((h, i) => `
                <div style="padding: 10px; margin-bottom: 8px; background: ${i === 0 ? '#e8f5e9' : '#f5f5f5'}; border-radius: 8px; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666;">${h.time}</span>
                        <span style="color: #2e7d32;">è¾“å…¥: ${h.newTokens} | è¾“å‡º: ${h.outputTokens}</span>
                    </div>
                    <div style="color: #333;">${h.query.substring(0, 50)}${h.query.length > 50 ? '...' : ''}</div>
                </div>
            `).join('');
        }
        
        // ==================== é™Œç”Ÿäººæ£€æµ‹æ¨¡å¼ ====================
        
        const strangerPersonUploadArea = document.getElementById('strangerPersonUploadArea');
        const strangerPersonImageInput = document.getElementById('strangerPersonImageInput');
        const strangerPersonPreview = document.getElementById('strangerPersonPreview');
        const strangerPersonNameInput = document.getElementById('strangerPersonNameInput');
        const addStrangerPersonBtn = document.getElementById('addStrangerPersonBtn');
        const strangerPersonsList = document.getElementById('strangerPersonsList');
        const strangerPersonCount = document.getElementById('strangerPersonCount');
        const strangerVideoUploadArea = document.getElementById('strangerVideoUploadArea');
        const strangerVideoInput = document.getElementById('strangerVideoInput');
        const strangerVideoPreviewContainer = document.getElementById('strangerVideoPreviewContainer');
        const strangerVideoPreview = document.getElementById('strangerVideoPreview');
        const strangerVideoInfo = document.getElementById('strangerVideoInfo');
        const startStrangerAnalyzeBtn = document.getElementById('startStrangerAnalyzeBtn');
        const strangerProgressSection = document.getElementById('strangerProgressSection');
        const strangerProgressBar = document.getElementById('strangerProgressBar');
        const strangerProgressText = document.getElementById('strangerProgressText');
        const strangerResultSection = document.getElementById('strangerResultSection');
        const strangerCacheStatusSection = document.getElementById('strangerCacheStatusSection');
        const deleteStrangerCacheBtn = document.getElementById('deleteStrangerCacheBtn');
        
        let strangerOwners = [];
        let strangerSelectedImageData = null;
        let strangerSelectedVideo = null;
        let strangerCacheId = null;
        
        // æˆ·ä¸»ç…§ç‰‡ä¸Šä¼ 
        strangerPersonUploadArea.addEventListener('click', () => strangerPersonImageInput.click());
        
        strangerPersonImageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    strangerSelectedImageData = e.target.result;
                    strangerPersonPreview.src = strangerSelectedImageData;
                    strangerPersonPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // æ·»åŠ æˆ·ä¸»
        addStrangerPersonBtn.addEventListener('click', function() {
            const name = strangerPersonNameInput.value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥æˆ·ä¸»åç§°');
                return;
            }
            if (!strangerSelectedImageData) {
                alert('è¯·å…ˆä¸Šä¼ æˆ·ä¸»ç…§ç‰‡');
                return;
            }
            if (strangerOwners.some(o => o.name === name)) {
                alert('è¯¥åç§°å·²å­˜åœ¨');
                return;
            }
            
            strangerOwners.push({ name, imageData: strangerSelectedImageData });
            renderStrangerOwnersList();
            
            // é‡ç½®
            strangerPersonNameInput.value = '';
            strangerSelectedImageData = null;
            strangerPersonPreview.style.display = 'none';
            strangerPersonImageInput.value = '';
            
            updateStartStrangerBtn();
        });
        
        function renderStrangerOwnersList() {
            strangerPersonCount.textContent = strangerOwners.length;
            if (strangerOwners.length === 0) {
                strangerPersonsList.innerHTML = '<p class="no-persons-text">æš‚æœªæ·»åŠ æˆ·ä¸»ç…§ç‰‡</p>';
            } else {
                strangerPersonsList.innerHTML = strangerOwners.map((o, i) => `
                    <div class="person-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #fff3e0; border-radius: 8px; margin-bottom: 6px; border: 2px solid #ff9800;">
                        <img src="${o.imageData}" alt="${o.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid #ff9800;">
                        <span style="flex: 1; font-weight: 500; color: #e65100;">${o.name}</span>
                        <button onclick="removeStrangerOwner(${i})" style="background: #ff5252; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">Ã—</button>
                    </div>
                `).join('');
            }
        }
        
        window.removeStrangerOwner = function(index) {
            strangerOwners.splice(index, 1);
            renderStrangerOwnersList();
            updateStartStrangerBtn();
        };
        
        // è§†é¢‘ä¸Šä¼ 
        strangerVideoUploadArea.addEventListener('click', () => strangerVideoInput.click());
        strangerVideoUploadArea.addEventListener('dragover', e => { e.preventDefault(); strangerVideoUploadArea.style.borderColor = '#1565c0'; });
        strangerVideoUploadArea.addEventListener('dragleave', () => { strangerVideoUploadArea.style.borderColor = '#2196f3'; });
        strangerVideoUploadArea.addEventListener('drop', e => {
            e.preventDefault();
            strangerVideoUploadArea.style.borderColor = '#2196f3';
            if (e.dataTransfer.files.length > 0) handleStrangerVideo(e.dataTransfer.files[0]);
        });
        
        strangerVideoInput.addEventListener('change', function() {
            if (this.files[0]) handleStrangerVideo(this.files[0]);
        });
        
        function handleStrangerVideo(file) {
            if (!file.type.startsWith('video/') && !file.name.match(/\.(mp4|webm|mov|avi|ts)$/i)) {
                alert('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶');
                return;
            }
            strangerSelectedVideo = file;
            strangerVideoPreview.src = URL.createObjectURL(file);
            strangerVideoPreviewContainer.style.display = 'block';
            strangerVideoInfo.textContent = `${file.name} | ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            strangerVideoUploadArea.style.display = 'none';
            updateStartStrangerBtn();
        }
        
        function updateStartStrangerBtn() {
            startStrangerAnalyzeBtn.disabled = !(strangerOwners.length > 0 && strangerSelectedVideo);
        }
        
        // å¼€å§‹é™Œç”Ÿäººæ£€æµ‹
        startStrangerAnalyzeBtn.addEventListener('click', async function() {
            if (strangerOwners.length === 0 || !strangerSelectedVideo) return;
            
            const mode = document.querySelector('input[name="strangerAnalyzeMode"]:checked').value;
            const prompt = document.getElementById('strangerPromptInput').value.trim();
            
            startStrangerAnalyzeBtn.disabled = true;
            startStrangerAnalyzeBtn.textContent = 'ğŸ”„ åˆ†æä¸­...';
            strangerProgressSection.style.display = 'block';
            strangerResultSection.style.display = 'none';
            strangerProgressBar.style.width = '10%';
            strangerProgressText.textContent = 'æ­£åœ¨ä¸Šä¼ æ•°æ®...';
            
            try {
                if (mode === 'direct') {
                    await analyzeStrangerDirect(prompt);
                } else {
                    await analyzeStrangerWithCache(prompt);
                }
            } catch (error) {
                alert('åˆ†æå¤±è´¥: ' + error.message);
                strangerProgressText.textContent = 'åˆ†æå¤±è´¥';
            } finally {
                startStrangerAnalyzeBtn.disabled = false;
                startStrangerAnalyzeBtn.textContent = 'ğŸ” å¼€å§‹é™Œç”Ÿäººæ£€æµ‹';
                updateStartStrangerBtn();
            }
        });
        
        // ç›´æ¥åˆ†ææ¨¡å¼
        async function analyzeStrangerDirect(prompt) {
            strangerProgressBar.style.width = '30%';
            strangerProgressText.textContent = 'æ­£åœ¨å‘é€è§†é¢‘å’Œæˆ·ä¸»ç…§ç‰‡...';
            
            const formData = new FormData();
            formData.append('video', strangerSelectedVideo);
            formData.append('owners', JSON.stringify(strangerOwners));
            formData.append('prompt', prompt);
            formData.append('media_resolution', mediaResolutionSelect.value);
            
            strangerProgressBar.style.width = '50%';
            strangerProgressText.textContent = 'Gemini åˆ†æä¸­...';
            
            const response = await fetch('/api/stranger/analyze', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            strangerProgressBar.style.width = '100%';
            strangerProgressText.textContent = 'åˆ†æå®Œæˆ!';
            
            if (data.success) {
                displayStrangerResult(data);
            } else {
                throw new Error(data.error || 'åˆ†æå¤±è´¥');
            }
        }
        
        // Cache æ¨¡å¼åˆ†æ
        async function analyzeStrangerWithCache(prompt) {
            // å¦‚æœæ²¡æœ‰ Cacheï¼Œå…ˆåˆ›å»º
            if (!strangerCacheId) {
                strangerProgressBar.style.width = '20%';
                strangerProgressText.textContent = 'æ­£åœ¨åˆ›å»º Cache...';
                
                const createFormData = new FormData();
                createFormData.append('owners', JSON.stringify(strangerOwners));
                createFormData.append('prompt', prompt);
                createFormData.append('model_id', modelSelect.value);
                
                const createResponse = await fetch('/api/stranger/create_cache', {
                    method: 'POST',
                    body: createFormData
                });
                
                const createData = await createResponse.json();
                
                if (!createData.success) {
                    throw new Error(createData.error || 'Cache åˆ›å»ºå¤±è´¥');
                }
                
                strangerCacheId = createData.cache_id;
                document.getElementById('strangerCacheId').textContent = createData.cache_id;
                document.getElementById('strangerCacheOwnerCount').textContent = createData.owner_count;
                document.getElementById('strangerCacheExpires').textContent = createData.expires_at;
                strangerCacheStatusSection.style.display = 'block';
            }
            
            // ä½¿ç”¨ Cache æŸ¥è¯¢
            strangerProgressBar.style.width = '50%';
            strangerProgressText.textContent = 'ä½¿ç”¨ Cache åˆ†æè§†é¢‘...';
            
            const queryFormData = new FormData();
            queryFormData.append('cache_id', strangerCacheId);
            queryFormData.append('video', strangerSelectedVideo);
            queryFormData.append('query', prompt || 'è¯·åˆ†æè¿™ä¸ªè§†é¢‘ä¸­æ˜¯å¦æœ‰é™Œç”Ÿäººã€‚');
            queryFormData.append('media_resolution', mediaResolutionSelect.value);
            
            const queryResponse = await fetch('/api/stranger/query_with_cache', {
                method: 'POST',
                body: queryFormData
            });
            
            const queryData = await queryResponse.json();
            
            strangerProgressBar.style.width = '100%';
            strangerProgressText.textContent = 'åˆ†æå®Œæˆ!';
            
            if (queryData.success) {
                displayStrangerResult(queryData);
            } else {
                throw new Error(queryData.error || 'æŸ¥è¯¢å¤±è´¥');
            }
        }
        
        // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
        function displayStrangerResult(data) {
            strangerResultSection.style.display = 'block';
            
            // è­¦å‘Šæ¡†
            const alertBox = document.getElementById('strangerAlertBox');
            const alertText = document.getElementById('strangerAlertText');
            
            if (data.has_stranger) {
                alertBox.style.background = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
                alertBox.style.border = '2px solid #f44336';
                alertText.style.color = '#c62828';
                alertText.innerHTML = 'âš ï¸ å‘ç°é™Œç”Ÿäººï¼';
            } else {
                alertBox.style.background = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
                alertBox.style.border = '2px solid #4caf50';
                alertText.style.color = '#2e7d32';
                alertText.innerHTML = 'âœ… å®‰å…¨ - æœªå‘ç°é™Œç”Ÿäºº';
            }
            
            // Token ç»Ÿè®¡
            if (data.token_stats) {
                document.getElementById('strangerInputTokens').textContent = data.token_stats.input_tokens || data.token_stats.prompt_token_count || '-';
                document.getElementById('strangerOutputTokens').textContent = data.token_stats.output_tokens || data.token_stats.candidates_token_count || '-';
            }
            document.getElementById('strangerProcessingTime').textContent = (data.processing_time || '-') + 's';
            
            // è¯¦ç»† Token ä¿¡æ¯
            if (data.token_details) {
                const details = data.token_details;
                const promptDetails = details.prompt_tokens_details || {};
                const candidatesDetails = details.candidates_tokens_details || {};
                
                // Input tokens è¯¦æƒ…
                document.getElementById('strangerInputTextTokens').textContent = promptDetails.text_tokens || 0;
                document.getElementById('strangerInputImageTokens').textContent = promptDetails.image_tokens || 0;
                document.getElementById('strangerInputVideoTokens').textContent = promptDetails.video_tokens || 0;
                document.getElementById('strangerInputAudioTokens').textContent = promptDetails.audio_tokens || 0;
                
                // Output tokens è¯¦æƒ…
                document.getElementById('strangerOutputTextTokens').textContent = candidatesDetails.text_tokens || 0;
                document.getElementById('strangerThinkingTokens').textContent = candidatesDetails.thinking_tokens || 0;
                
                // ç¼“å­˜ tokens
                document.getElementById('strangerCachedTokens').textContent = details.cached_content_token_count || 0;
                
                document.getElementById('strangerTokenDetailsSection').style.display = 'block';
            } else {
                document.getElementById('strangerTokenDetailsSection').style.display = 'none';
            }
            
            // åˆ†æå†…å®¹
            document.getElementById('strangerAnalysisContent').textContent = data.analysis || 'æ— åˆ†æç»“æœ';
        }
        
        // åˆ é™¤ Cache
        deleteStrangerCacheBtn.addEventListener('click', async function() {
            if (!strangerCacheId) return;
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤ Cache å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/api/stranger/delete_cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cache_id: strangerCacheId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    strangerCacheId = null;
                    strangerCacheStatusSection.style.display = 'none';
                    alert('Cache å·²åˆ é™¤');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        });
        
        // éšè—é™Œç”Ÿäººæ£€æµ‹æ¨¡å¼çš„é€šç”¨æç¤ºè¯å’ŒæŒ‰é’®
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                if (this.dataset.mode === 'stranger') {
                    document.querySelector('.prompt-section').style.display = 'none';
                    document.getElementById('submitBtn').style.display = 'none';
                    document.getElementById('submitLangchainBtn').style.display = 'none';
                    document.getElementById('resultSection').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
